<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nitrogen Mustards</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <style>
         .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1a2980;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        
        .sidebar-toggle-icon {
            font-size: 20px;
            color: white;
        }
        
        /* WHITE SIDEBAR STYLES */
        .sidebar {
            width: 280px;
            background: white;
            color: #333;
            padding: 30px 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 999;
            left: -280px;
            top: 0;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.05);
            border-right: 1px solid #eee;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar h2 {
            color: #1a2980;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            font-size: 1.5rem;
        }
        
        /* NAVIGATION LINKS */
        .nav-links {
            list-style: none;
            padding: 0;
        }
        
        .nav-links li {
            margin-bottom: 10px;
        }
        
        .nav-links a {
            color: #555;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.1);
        }

        /* SUBMENU STYLES */
        .sub-links {
            list-style: none;
            padding-left: 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .has-submenu.active .sub-links {
            max-height: 500px;
        }

        .sub-links a {
            padding: 8px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        
        .sub-links a:hover {
            background-color: #f8f9fa;
        }

        .sub-links.active {
            display: block;
        }

        .has-submenu {
            position: relative;
        }

        .has-submenu::after {
            content: '▼';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .has-submenu.active::after {
            transform: translateY(-50%) rotate(180deg);
        }

        
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
        width: 100%;
        height: 100%;
        font-family: 'Arial', sans-serif;
        color: #333;
        line-height: 1.6;
        scroll-behavior: smooth;
        background: #f5f7fa;
        }

        body {
            overflow-x: hidden;
            overflow-y: auto;
            margin: 0;
        }

        .scene {
            min-height: auto;
            height:auto;
            padding: 80px 40px;
            margin-bottom: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            max-width: 1000px;
            margin: 60px auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: visible;
        }

        .header {
            text-align: center;
            padding: 80px 20px 60px;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            position: relative;
            z-index: 10;
            clip-path: polygon(0 0, 100% 0, 100% 90%, 0 100%);
            margin-bottom: -30px;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.3rem;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .sidebar-expanded .main-content {
                position: fixed;
                left: 250px;
                width: 100%;
            }
            
            .sidebar-expanded::after {
                content: '';
                position: fixed;
                top: 0;
                left: 250px;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 998;
            }
        }

        @media (max-width: 576px) {
            .header {
                padding: 60px 20px 40px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .team-members {
                padding: 20px;
                margin-bottom: 40px;
            }
            
            .scene {
                padding: 40px 20px;
                margin: 30px auto;
            }
            
            .scene h2 {
                font-size: 1.5rem;
            }
            
            .battlefield, .lab, .dna-animation, .treatment-scene {
                height: 280px;
            }
            
            .drug-types {
                gap: 15px;
            }
            
            .drug-card {
                width: 140px;
                height: 140px;
            }
            
            .drug-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .drug-card h4 {
                font-size: 16px;
                margin: 10px 0 5px;
            }
            
            .chemical-structure {
                height: 120px;
                margin: 30px 0;
            }
            
            .footer {
                padding: 60px 20px;
            }
            
            .footer p {
                font-size: 1.1rem;
            }
        }

    
        .drug-card {
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .drug-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .drug-card-link {
            text-decoration: none;
            color: inherit;
        }

        .animation-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 10000;
            white-space: nowrap;
            transform: translate(-50%, -110%);
        }

        .key-points, .activation-pathway {
            background: rgba(245, 245, 245, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #1a2980;
        }

        .comparison-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }

        .comparison-table th, .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table th {
            background-color: #1a2980;
            color: white;
        }

        .comparison-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .molecular-detail {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        @keyframes highlight {
            from { background-color: rgba(100, 200, 255, 0.3); }
            to { background-color: transparent; }
        }

        :target {
            animation: highlight 2s ease;
        }


.scene.chemistry-theme {
            width: 100%;
            padding: 2rem;
            background: 
                url('https://www.transparenttextures.com/patterns/hexellence.png') repeat,
                linear-gradient(135deg, #f0f8ff 0%, #e0f7fa 100%);
            background-blend-mode: overlay;
            box-shadow: inset 0 0 0 1000px rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            border-top: 6px solid #4db6ac;
            border-bottom: 6px solid #4db6ac;
            box-sizing: border-box;

            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            align-items: center; /* ✅ Center content vertically */
            justify-content: center;
        }

        .source-caption {
            text-align: center;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 1.5rem;
        }

        .main-caption {
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
            color: #00796b;
            margin-top: 1rem;
        }

        #img2 {
      display: none;
      margin-top: 10px;
    }

    img {
      cursor: pointer;
      max-width: 200px;
    }

    .scene img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            display: block;
            margin: 0 auto;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .navigation-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
    }
    
    .navigation-buttons button {
        padding: 12px 24px;
        border: none;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .navigation-buttons button:nth-child(1),
    .navigation-buttons button:nth-child(2) {
        background: linear-gradient(135deg, #1a2980, #26d0ce);
        color: white;
    }
    
    .navigation-buttons button:last-child {
        background: linear-gradient(135deg, #ff416c, #ff4b2b);
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .navigation-buttons button:last-child::after {
        content: '↻';
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
    }
    
    .navigation-buttons button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .navigation-buttons button:active {
        transform: translateY(1px);
    }
    
    .navigation-buttons button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    .mechanism-visualization {
            height: 400px;
            position: relative;
            margin: 30px 0;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            border: 1px solid #eee;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .mechanism-visualization::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="1" height="1" fill="%23eee"/></svg>');
            opacity: 0.3;
        }
        
        .molecule-label {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, -50%);
        }
        
        .dna-strand {
            position: absolute;
            width: 300px;
            height: 60px;
            background: linear-gradient(to right, #4CAF50, #8BC34A);
            border-radius: 30px;
            opacity: 0;
            transform: scale(0.8);
        }
        
        .blood-brain-barrier {
            position: absolute;
            width: 100%;
            height: 3px;
            background: #1a2980;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            opacity: 0.7;
        }

    </style>
</head>

<body>
        <!-- Sidebar Toggle Button -->
    <div class="sidebar-toggle" id="sidebarToggle">
        <span class="sidebar-toggle-icon">☰</span>
    </div>

    <div class="sidebar">
        <h2>Navigation</h2>
        <ul class="nav-links">
            <li><a href="historical.html">Warhead and Wonder drugs</a></li>
            <li><a href="mechanism.html">Cellular blueprints</a></li>
            <li class="has-submenu">
                <a href="agents.html">Weapons of the cell war</a>
                <ul class="sub-links">
                  <li><a href="agents.html">Summary</a></li>
                  <li><a href="nitrogen-mustards.html">Nitrogen Mustards</a></li>
                  <li><a href="oxazaphosphorines.html">Oxazaphosphorines</a></li>
                  <li><a href="nitrosoureas.html">Nitrosourea</a></li>
                  <li><a href="mitomycin-c.html">Mitomycin C</a></li>
                </ul>
              </li>
            <li><a href="references.html">References</a></li>
            <li><a href="index.html">Authors</a></li>
        </ul>
    </div>


    <div class="header">
        <h1>From Mustard Gas to Chemotherapy</h1>
        <p>From chemical warfare to cancer cure, the alchemical evolution of chemotherapy drugs</p>
    </div>

    <div class="scene">
        <h2>Oxazaphosphorines</h2>
    </div>

    <div class="scene chemistry-theme">
        <figure>

            <img src="oxaza1.png" alt="Oxazaphosphorines 1">
            <!--<figcaption class="main-caption">Nitrogen Mustard Activation Pathway</figcaption>-->
            <figcaption class="source-caption">
                <i>Credit to WHERE IS THE SOURCE!!! </i>
    
            </figcaption>
        </figure>
        <p class="description">
            <strong>Cyclophosphamide (CP)</strong> is hydroxylated by P450 enzymes in the liver (Cytochrome P450) to <strong>4-hydroxycyclophosphamide (OHCP)</strong>.
        </p>
    </div>

    <div class="scene chemistry-theme">
        <figure>

            <img src="oxaza2.png" alt="Oxazaphosphorines 2">
            <!--<figcaption class="main-caption">Nitrogen Mustard Activation Pathway</figcaption>-->
            <figcaption class="source-caption">
                <i>Credit to WHERE IS THE SOURCE!!! </i>
    
            </figcaption>
        </figure>
        <p class="description">
            4-hydroxycyclophosphamide has a tautomer that is created in the process called Aldophosphamide (ALDO).
        </p>
    </div>

    <div class="scene chemistry-theme">
        <figure>

            <img src="oxaza3.png" alt="Oxazaphosphorines 3">
            <!--<figcaption class="main-caption">Nitrogen Mustard Activation Pathway</figcaption>-->
            <figcaption class="source-caption">
                <i>Credit to WHERE IS THE SOURCE!!! </i>
    
            </figcaption>
        </figure>
        <p class="description">
            Aldophosphamide is decomposed by Phosphodiesterases (PDE) to form Phosphamide Mustard (PAM) through the β-elimination reaction
        </p>
    </div>

    <div class="scene chemistry-theme">
        <figure>

            <img src="https://2.wlimg.com/product_images/bc-full/2018/10/5382728/cyclophosphamide-injection-1538722219-4056054.jpeg" alt="Cyclophosphamide">
            <figcaption class="main-caption">Cyclophosphamide</figcaption>
            <figcaption class="source-caption">
                <i>Credit to WLimg. (n.d.). [Image of cyclophosphamide injection]</i>
            </figcaption>
        </figure>
        <p class="description">
            <ul>
            <li>Drugs under the oxazaphosphorine class include Ifosfamide and Cyclophosphamide</li>

            <li>Oxazaphosphamides drugs are commonly used to treat sarcoma and other solid tumors</li>
            
            </ul>
            
        </p>
    </div>


    <div class="scene" id="oxazaphosphorine-mechanism">
        <h2>Oxazaphosphorine Animation</h2>
        <div class="mechanism-flex">
            <div class="mechanism-visualization">
                <svg id="ox-animation" width="780" height="400" viewBox="0 0 780 400"></svg>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #007bff;"></div><span>5'-3' Backbone (Blue)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #dc3545;"></div><span>3'-5' Backbone (Red)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #F08080;"></div><span>Adenine (A)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #F5D67D;"></div><span>Thymine (T)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #58D68D;"></div><span>Guanine (G)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #5DADE2;"></div><span>Cytosine (C)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #BDC3C7;"></div><span>Hydrogen Bonds</span></div>
            </div>
        </div>
        <div class="explanation-box">
            <h3 id="ox-step-title">Oxazaphosphorine: Step 1</h3>
            <p class="explanation-text" id="ox-explanation"></p>
        </div>
        <div class="navigation-buttons">
            <button id="ox-prev-btn" onclick="navigateTo('previous')">Previous</button>
            <button id="ox-next-btn" onclick="navigateTo('next')">Next</button>
            <button onclick="navigateTo('restart')">Restart</button>
        </div>
    </div>
    
    <style>
    .mechanism-flex {
        display: flex;
        gap: 40px;
        align-items: flex-start;
        flex-wrap: wrap;
        margin-top: 10px;
        margin-bottom: 12px;
        width: 100%;
    }
    .mechanism-visualization {
        min-width: 780px;
        min-height: 400px;
        background: rgba(255,255,255,0.9);
        border-radius: 10px;
        border: 1px solid #eee;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .legend {
        min-width: 190px;
        padding: 18px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #ddd;
        box-shadow: 0 1px 4px #0001;
        font-size: 15px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 9px;
    }
    .legend-color {
        width: 19px;
        height: 19px;
        border-radius: 4px;
        margin-right: 10px;
        border: 1px solid #bbb;
    }
    @media (max-width: 900px) {
        .mechanism-flex { flex-direction: column; align-items: center; gap: 14px; }
        .mechanism-visualization, .legend { min-width: 0; width: 95vw; max-width: 780px;}
    }
    </style>
    
    <script>
    const svgNS = "http://www.w3.org/2000/svg";
    
    function addGlowFilter(svg) {
        let existing = svg.querySelector('defs#glow-defs');
        if (existing) return;
        let defs = document.createElementNS(svgNS, 'defs');
        defs.setAttribute('id', 'glow-defs');
        let filter = document.createElementNS(svgNS, 'filter');
        filter.setAttribute('id', 'glow');
        filter.setAttribute('x', '-50%');
        filter.setAttribute('y', '-50%');
        filter.setAttribute('width', '200%');
        filter.setAttribute('height', '200%');
        let feDropShadow = document.createElementNS(svgNS, 'feDropShadow');
        feDropShadow.setAttribute('dx', '0');
        feDropShadow.setAttribute('dy', '0');
        feDropShadow.setAttribute('stdDeviation', '4');
        feDropShadow.setAttribute('flood-color', '#FFD600');
        feDropShadow.setAttribute('flood-opacity', '0.9');
        filter.appendChild(feDropShadow);
        defs.appendChild(filter);
        svg.appendChild(defs);
    }
    
    const AtomColors = {
        'C': '#444',
        'O': '#1976D2',
        'N': '#43A047',
        'P': '#D81B60',
        'Cl': '#FFA726',
        'H': '#BBB'
    };
    
    function labelStructure(svg, label, x, y, color="#333") {
        const t = document.createElementNS(svgNS, "text");
        t.setAttribute("x", x);
        t.setAttribute("y", y);
        t.setAttribute("text-anchor", "middle");
        t.setAttribute("font-size", "20px");
        t.setAttribute("font-weight", "bold");
        t.setAttribute("fill", color);
        t.textContent = label;
        svg.appendChild(t);
    }
    
    function drawCyclophosphamideStructure(svg, xOffset, yOffset, scale=1.2) {
        function atom(x, y, label, colorKey, atomId) {
            const group = document.createElementNS(svgNS, "g");
            group.setAttribute("id", "atom-"+atomId);
            const circle = document.createElementNS(svgNS, "circle");
            circle.setAttribute("cx", x);
            circle.setAttribute("cy", y);
            circle.setAttribute("r", 14 * scale);
            circle.setAttribute("fill", AtomColors[colorKey] || "#bbb");
            circle.setAttribute("stroke", "#333");
            circle.setAttribute("stroke-width", "2");
            group.appendChild(circle);
            const text = document.createElementNS(svgNS, "text");
            text.setAttribute("x", x);
            text.setAttribute("y", y+6*scale);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("font-size", 18*scale);
            text.setAttribute("fill", "#fff");
            text.setAttribute("font-weight", "bold");
            text.textContent = label;
            group.appendChild(text);
            svg.appendChild(group);
        }
        function bond(x1, y1, x2, y2, thick=false) {
            const line = document.createElementNS(svgNS, "line");
            line.setAttribute("x1", x1); line.setAttribute("y1", y1);
            line.setAttribute("x2", x2); line.setAttribute("y2", y2);
            line.setAttribute("stroke", "#888");
            line.setAttribute("stroke-width", thick ? 6 : 3);
            svg.appendChild(line);
        }
        const P = [xOffset+110, yOffset+90];
        const O1 = [xOffset+170, yOffset+70];
        const O2 = [xOffset+165, yOffset+130];
        const N1 = [xOffset+55, yOffset+50];
        const N2 = [xOffset+55, yOffset+130];
        const Cl1 = [xOffset+20, yOffset+30];
        const Cl2 = [xOffset+20, yOffset+150];
        const C1 = [xOffset+85, yOffset+40];
        const C2 = [xOffset+85, yOffset+140];
        const backbone = [xOffset+110, yOffset+190];
        bond(...P, ...O1);
        bond(...P, ...O2);
        bond(...P, ...N1, true);
        bond(...P, ...N2, true);
        bond(...N1, ...Cl1);
        bond(...N2, ...Cl2);
        bond(...N1, ...C1);
        bond(...N2, ...C2);
        bond(...C1, ...backbone);
        bond(...C2, ...backbone);
        atom(...P, 'P', 'P', 'P');
        atom(...O1, 'O', 'O', 'O1');
        atom(...O2, 'O', 'O', 'O2');
        atom(...N1, 'N', 'N', 'N1');
        atom(...N2, 'N', 'N', 'N2');
        atom(...Cl1, 'Cl', 'Cl', 'Cl1');
        atom(...Cl2, 'Cl', 'Cl', 'Cl2');
        atom(...C1, 'C', 'C', 'C1');
        atom(...C2, 'C', 'C', 'C2');
        atom(...backbone, 'C', 'C', 'CB');
        labelStructure(svg, "Cyclophosphamide", xOffset+110, yOffset+270, "#1976D2");
    }
    
    function drawOHCPStructure(svg, x, y, scale=1.2) {
        drawCyclophosphamideStructure(svg, x, y, scale);
        const ox = x+180, oy = y+40;
        const line = document.createElementNS(svgNS, "line");
        line.setAttribute("x1", x+170); line.setAttribute("y1", y+70);
        line.setAttribute("x2", ox); line.setAttribute("y2", oy);
        line.setAttribute("stroke", "#1976D2"); line.setAttribute("stroke-width", 3);
        svg.appendChild(line);
        const circle = document.createElementNS(svgNS, "circle");
        circle.setAttribute("cx", ox); circle.setAttribute("cy", oy);
        circle.setAttribute("r", 10);
        circle.setAttribute("fill", AtomColors.O);
        svg.appendChild(circle);
        const textO = document.createElementNS(svgNS, "text");
        textO.setAttribute("x", ox); textO.setAttribute("y", oy+5);
        textO.setAttribute("text-anchor", "middle");
        textO.setAttribute("font-size", "14px");
        textO.setAttribute("fill", "#fff");
        textO.setAttribute("font-weight", "bold");
        textO.textContent = "O";
        svg.appendChild(textO);
        const hx = ox+18, hy = oy-6;
        const hline = document.createElementNS(svgNS, "line");
        hline.setAttribute("x1", ox); hline.setAttribute("y1", oy);
        hline.setAttribute("x2", hx); hline.setAttribute("y2", hy);
        hline.setAttribute("stroke", "#BBB"); hline.setAttribute("stroke-width", 2);
        svg.appendChild(hline);
        const h = document.createElementNS(svgNS, "text");
        h.setAttribute("x", hx); h.setAttribute("y", hy-2);
        h.setAttribute("font-size", "12px");
        h.setAttribute("fill", AtomColors.H);
        h.textContent = "H";
        svg.appendChild(h);
        labelStructure(svg, "4-hydroxycyclophosphamide", x+110, y+290, "#43A047");
    }
    
    function drawAldophosphamideStructure(svg, x, y, scale=1.2) {
        drawCyclophosphamideStructure(svg, x, y, scale);
        const ax = x+110, ay = y+210;
        const line = document.createElementNS(svgNS, "line");
        line.setAttribute("x1", x+110); line.setAttribute("y1", y+190);
        line.setAttribute("x2", ax); line.setAttribute("y2", ay);
        line.setAttribute("stroke", "#FFA726"); line.setAttribute("stroke-width", 3);
        svg.appendChild(line);
        const text = document.createElementNS(svgNS, "text");
        text.setAttribute("x", ax+18); text.setAttribute("y", ay+6);
        text.setAttribute("font-size", "15px");
        text.setAttribute("fill", "#FFA726");
        text.textContent = "CHO";
        svg.appendChild(text);
        labelStructure(svg, "Aldophosphamide", x+110, y+290, "#FFA726");
    }
    
    function drawPMStructure(svg, x, y, scale=1.2) {
        const c = document.createElementNS(svgNS, "circle");
        c.setAttribute("cx", x+110); c.setAttribute("cy", y+90);
        c.setAttribute("r", 20*scale);
        c.setAttribute("fill", "#D81B60");
        c.setAttribute("stroke", "#333"); c.setAttribute("stroke-width", "2");
        svg.appendChild(c);
        function arm(x1, y1, x2, y2, x3, y3, id) {
            const l1 = document.createElementNS(svgNS, "line");
            l1.setAttribute("x1", x1); l1.setAttribute("y1", y1);
            l1.setAttribute("x2", x2); l1.setAttribute("y2", y2);
            l1.setAttribute("stroke", "#43A047"); l1.setAttribute("stroke-width", 5);
            svg.appendChild(l1);
            const l2 = document.createElementNS(svgNS, "line");
            l2.setAttribute("x1", x2); l2.setAttribute("y1", y2);
            l2.setAttribute("x2", x3); l2.setAttribute("y2", y3);
            l2.setAttribute("stroke", "#FFA726"); l2.setAttribute("stroke-width", 4);
            svg.appendChild(l2);
            const cl = document.createElementNS(svgNS, "text");
            cl.setAttribute("x", x3+7); cl.setAttribute("y", y3+2);
            cl.setAttribute("font-size", "17px");
            cl.setAttribute("fill", AtomColors.Cl);
            cl.setAttribute("font-weight", "bold");
            cl.textContent = "Cl";
            svg.appendChild(cl);
        }
        arm(x+110, y+90, x+30, y+40, x+10, y+20, 1);
        arm(x+110, y+90, x+30, y+140, x+10, y+170, 2);
        const n = document.createElementNS(svgNS, "text");
        n.setAttribute("x", x+110); n.setAttribute("y", y+90+7);
        n.setAttribute("text-anchor", "middle");
        n.setAttribute("font-size", "22px");
        n.setAttribute("fill", AtomColors.N);
        n.setAttribute("font-weight", "bold");
        n.textContent = "N";
        svg.appendChild(n);
        labelStructure(svg, "Phosphoramide Mustard", x+110, y+200, "#D81B60");
    }
    
    function drawAcroleinStructure(svg, x, y, scale=1.2) {
        const l = document.createElementNS(svgNS, "line");
        l.setAttribute("x1", x+40); l.setAttribute("y1", y+90);
        l.setAttribute("x2", x+160); l.setAttribute("y2", y+90);
        l.setAttribute("stroke", "#444"); l.setAttribute("stroke-width", 4);
        svg.appendChild(l);
        const l2 = document.createElementNS(svgNS, "line");
        l2.setAttribute("x1", x+40); l2.setAttribute("y1", y+90);
        l2.setAttribute("x2", x+30); l2.setAttribute("y2", y+70);
        l2.setAttribute("stroke", "#444"); l2.setAttribute("stroke-width", 2);
        svg.appendChild(l2);
        const h2 = document.createElementNS(svgNS, "text");
        h2.setAttribute("x", x+18); h2.setAttribute("y", y+65);
        h2.setAttribute("font-size", "15px");
        h2.setAttribute("fill", AtomColors.H);
        h2.textContent = "H2C";
        svg.appendChild(h2);
        const o = document.createElementNS(svgNS, "text");
        o.setAttribute("x", x+160+18); o.setAttribute("y", y+90+6);
        o.setAttribute("font-size", "16px");
        o.setAttribute("fill", AtomColors.O);
        o.textContent = "O";
        svg.appendChild(o);
        const d = document.createElementNS(svgNS, "line");
        d.setAttribute("x1", x+160); d.setAttribute("y1", y+90);
        d.setAttribute("x2", x+160); d.setAttribute("y2", y+70);
        d.setAttribute("stroke", AtomColors.O); d.setAttribute("stroke-width", 3);
        svg.appendChild(d);
        labelStructure(svg, "Acrolein", x+100, y+200, "#607D8B");
    }
    
    function createBond(svg, id, x1, y1, x2, y2, color = "#FBC02D", width = 4, options = {}) {
        const line = document.createElementNS(svgNS, "line");
        line.setAttribute("id", id);
        line.setAttribute("x1", x1);
        line.setAttribute("y1", y1);
        line.setAttribute("x2", x2);
        line.setAttribute("y2", y2);
        line.setAttribute("stroke", color);
        line.setAttribute("stroke-width", width);
        if (options.dash) line.setAttribute("stroke-dasharray", "10,6");
        if (options.glow) line.setAttribute("filter", "url(#glow)");
        svg.appendChild(line);
    
        if (options.label) {
            const text = document.createElementNS(svgNS, "text");
            text.setAttribute("x", (x1 + x2) / 2 + (options.labelOffsetX || 12));
            text.setAttribute("y", (y1 + y2) / 2 + (options.labelOffsetY || -12));
            text.setAttribute("fill", options.labelColor || "#D32F2F");
            text.setAttribute("font-size", "16px");
            text.setAttribute("font-weight", "bold");
            text.textContent = options.label;
            svg.appendChild(text);
        }
        return line;
    }
    
    function createLabel(svg, id, x, y, text) {
        const label = document.createElementNS(svgNS, "text");
        label.setAttribute("id", id);
        label.setAttribute("x", x);
        label.setAttribute("y", y);
        label.setAttribute("text-anchor", "middle");
        label.setAttribute("alignment-baseline", "middle");
        label.textContent = text;
        svg.appendChild(label);
        return label;
    }
    
    function showAnimationTooltip(e, html) { /* stub */ }
    function hideAnimationTooltip() { /* stub */ }
    
    function createDetailedDNAStrands(svg, idPrefix, x_center, y_offset, overall_height, numSegments = 10) {
        const group = document.createElementNS(svgNS, 'g');
        group.setAttribute('id', `${idPrefix}-dna-helix`);
        svg.appendChild(group);
    
        const amplitude = 40, frequency = 0.025, segmentStep = 2;
        const backboneColorBlue = '#007bff', backboneColorRed = '#dc3545';
        const adenineColor = '#F08080', thymineColor = '#F5D67D', guanineColor = '#58D68D', cytosineColor = '#5DADE2', hBondColor = '#BDC3C7';
        const backboneWidth = 5, baseRectWidthPurine = 18, baseRectHeightPurine = 10, baseRectWidthPyrimidine = 14, baseRectHeightPyrimidine = 10, baseFontSize = "8px";
        const allElements = [];
        const sequence = ['A', 'T', 'G', 'C', 'G', 'T', 'A', 'C', 'G', 'A'];
        const numBasePairs = sequence.length;
        const basePairSpacing = overall_height / (numBasePairs + 1);
    
        const strandBlue = document.createElementNS(svgNS, 'path');
        const strandRed = document.createElementNS(svgNS, 'path');
        let dBlue = '', dRed = '';
        const startY = y_offset;
        const endY = y_offset + overall_height;
        for (let currentY = startY; currentY <= endY; currentY += segmentStep) {
            const xBlue = x_center - amplitude * Math.cos(frequency * (currentY - startY));
            const xRed  = x_center - amplitude * Math.cos(frequency * (currentY - startY) + Math.PI);
            if (currentY === startY) {
                dBlue += `M${xBlue},${currentY}`;
                dRed += `M${xRed},${currentY}`;
            } else {
                dBlue += ` L${xBlue},${currentY}`;
                dRed += ` L${xRed},${currentY}`;
            }
        }
        strandBlue.setAttribute('d', dBlue);
        strandBlue.setAttribute('stroke', backboneColorBlue);
        strandBlue.setAttribute('stroke-width', backboneWidth);
        strandBlue.setAttribute('fill', 'none');
        group.appendChild(strandBlue);
        allElements.push(strandBlue);
    
        strandRed.setAttribute('d', dRed);
        strandRed.setAttribute('stroke', backboneColorRed);
        strandRed.setAttribute('stroke-width', backboneWidth);
        strandRed.setAttribute('fill', 'none');
        group.appendChild(strandRed);
        allElements.push(strandRed);
    
        const fivePrimeBlue = createLabel(svg, `${idPrefix}-5pb`, x_center - amplitude - 15, startY, "5'");
        const threePrimeBlue = createLabel(svg, `${idPrefix}-3pb`, x_center - amplitude * Math.cos(frequency * overall_height) - 15, endY + 15, "3'");
        const threePrimeRed = createLabel(svg, `${idPrefix}-3pr`, x_center - amplitude * Math.cos(Math.PI) + 15, startY, "3'");
        const fivePrimeRed = createLabel(svg, `${idPrefix}-5pr`, x_center - amplitude * Math.cos(frequency * overall_height + Math.PI) + 15, endY + 15, "5'");
        allElements.push(fivePrimeBlue, threePrimeBlue, threePrimeRed, fivePrimeRed);
    
        for (let i = 0; i < numBasePairs; i++) {
            const currentY = y_offset + (i + 1) * basePairSpacing;
            const xBlue = x_center - amplitude * Math.cos(frequency * (currentY - startY));
            const xRed  = x_center - amplitude * Math.cos(frequency * (currentY - startY) + Math.PI);
    
            const baseTypeStrand1 = sequence[i];
            let baseTypeStrand2, color1, color2, width1, height1, width2, height2, label1, label2;
            switch (baseTypeStrand1) {
                case 'A':
                    baseTypeStrand2 = 'T'; color1 = adenineColor; color2 = thymineColor;
                    width1 = baseRectWidthPurine; height1 = baseRectHeightPurine;
                    width2 = baseRectWidthPyrimidine; height2 = baseRectHeightPyrimidine;
                    label1 = 'A'; label2 = 'T';
                    break;
                case 'T':
                    baseTypeStrand2 = 'A'; color1 = thymineColor; color2 = adenineColor;
                    width1 = baseRectWidthPyrimidine; height1 = baseRectHeightPyrimidine;
                    width2 = baseRectWidthPurine; height2 = baseRectHeightPurine;
                    label1 = 'T'; label2 = 'A';
                    break;
                case 'G':
                    baseTypeStrand2 = 'C'; color1 = guanineColor; color2 = cytosineColor;
                    width1 = baseRectWidthPurine; height1 = baseRectHeightPurine;
                    width2 = baseRectWidthPyrimidine; height2 = baseRectHeightPyrimidine;
                    label1 = 'G'; label2 = 'C';
                    break;
                case 'C':
                    baseTypeStrand2 = 'G'; color1 = cytosineColor; color2 = guanineColor;
                    width1 = baseRectWidthPyrimidine; height1 = baseRectHeightPyrimidine;
                    width2 = baseRectWidthPurine; height2 = baseRectHeightPurine;
                    label1 = 'C'; label2 = 'G';
                    break;
            }
    
            const base1 = document.createElementNS(svgNS, 'rect');
            base1.setAttribute('id', `${idPrefix}-base1-${i}`);
            base1.setAttribute('x', xBlue - width1/2);
            base1.setAttribute('y', currentY - height1/2);
            base1.setAttribute('width', width1);
            base1.setAttribute('height', height1);
            base1.setAttribute('fill', color1);
            base1.setAttribute('rx', 2); base1.setAttribute('ry', 2);
            group.appendChild(base1);
            allElements.push(base1);
    
            const baseLabel1 = createLabel(svg, `${idPrefix}-b1label-${i}`, xBlue, currentY + 2, label1);
            allElements.push(baseLabel1);
    
            const base2 = document.createElementNS(svgNS, 'rect');
            base2.setAttribute('id', `${idPrefix}-base2-${i}`);
            base2.setAttribute('x', xRed - width2/2);
            base2.setAttribute('y', currentY - height2/2);
            base2.setAttribute('width', width2);
            base2.setAttribute('height', height2);
            base2.setAttribute('fill', color2);
            base2.setAttribute('rx', 2); base2.setAttribute('ry', 2);
            group.appendChild(base2);
            allElements.push(base2);
    
            const baseLabel2 = createLabel(svg, `${idPrefix}-b2label-${i}`, xRed, currentY + 2, label2);
            allElements.push(baseLabel2);
    
            const hBond = document.createElementNS(svgNS, 'line');
            hBond.setAttribute('x1', xBlue);
            hBond.setAttribute('y1', currentY);
            hBond.setAttribute('x2', xRed);
            hBond.setAttribute('y2', currentY);
            hBond.setAttribute('stroke', hBondColor);
            hBond.setAttribute('stroke-width', '2');
            group.appendChild(hBond);
            allElements.push(hBond);
    
            if (baseTypeStrand1 === 'G') {
                base1.dataset.n7x = xBlue + (width1 / 2) * 0.6;
                base1.dataset.n7y = currentY;
            }
            if (baseTypeStrand2 === 'G') {
                base2.dataset.n7x = xRed - (width2 / 2) * 0.6;
                base2.dataset.n7y = currentY;
            }
        }
    
        return { group, elements: allElements, path1: strandBlue, path2: strandRed };
    }
    
    const stepExplanations = [
        "Cyclophosphamide is a prodrug that is activated in the liver. The structure is shown and labeled.",
        "Cytochrome P450 enzymes convert cyclophosphamide into 4-hydroxycyclophosphamide (OHCP) as seen by the new hydroxyl group.",
        "4-hydroxycyclophosphamide can tautomerize to aldophosphamide, shown here with the new aldehyde group (CHO) at the bottom.",
        "Aldophosphamide decomposes to phosphoramide mustard (PM) and acrolein. Both structures are shown.",
        "Phosphoramide mustard (PM) forms a covalent bond with the N7 atom of guanine (G) in DNA.",
        "PM can cross-link two guanine (G) bases on DNA, preventing replication and leading to cell death."
    ];
    
    const improvedAnimations = [
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            drawCyclophosphamideStructure(svg, 60, 60, 1.0);
        },
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            drawOHCPStructure(svg, 60, 60, 1.0);
        },
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            drawAldophosphamideStructure(svg, 60, 60, 1.0);
        },
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            drawPMStructure(svg, 80, 90, 1.0);
            drawAcroleinStructure(svg, 400, 90, 1.0);
        },
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            drawPMStructure(svg, 110, 130, 0.9);
            const dnaData = createDetailedDNAStrands(svg, 'dna-ox', 600, 60, 260, 10);
            let g1 = null;
            for (let el of dnaData.elements) {
                if (el.tagName === "rect" && el.dataset.n7x && el.dataset.n7y) {
                    g1 = {x: parseFloat(el.dataset.n7x), y: parseFloat(el.dataset.n7y)};
                    break;
                }
            }
            if (g1) {
                createBond(svg, 'pm-dna', 170, 175, g1.x, g1.y, "#FBC02D", 5, {glow: true});
            }
        },
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            const dnaData = createDetailedDNAStrands(svg, 'dna-ox', 400, 60, 260, 10);
            let guanines = [];
            for (let el of dnaData.elements) {
                if (el.tagName === "rect" && el.dataset.n7x && el.dataset.n7y) {
                    guanines.push({x: parseFloat(el.dataset.n7x), y: parseFloat(el.dataset.n7y)});
                }
            }
            if (guanines.length >= 2) {
                createBond(
                    svg, 'crosslink',
                    guanines[0].x, guanines[0].y,
                    guanines[1].x, guanines[1].y,
                    "#D32F2F", 9,
                    {
                        dash: true,
                        label: "DNA Cross-Link",
                        labelColor: "#D32F2F",
                        glow: true,
                        labelOffsetX: 24,
                        labelOffsetY: -24
                    }
                );
            }
        }
    ];
    
    function clearSVG(id) {
        const svg = document.getElementById(id);
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        addGlowFilter(svg);
    }
    
    let currentStep = 0;
    function updateExplanation() {
        document.getElementById('ox-explanation').innerText = stepExplanations[currentStep];
        document.getElementById('ox-step-title').innerText = "Oxazaphosphorine: Step " + (currentStep + 1);
    }
    function showStep() {
        improvedAnimations[currentStep]();
        updateExplanation();
        document.getElementById('ox-prev-btn').disabled = currentStep === 0;
        document.getElementById('ox-next-btn').disabled = currentStep === improvedAnimations.length-1;
    }
    function navigateTo(action) {
        if (action === "next" && currentStep < improvedAnimations.length-1) currentStep++;
        else if (action === "previous" && currentStep > 0) currentStep--;
        else if (action === "restart") currentStep = 0;
        showStep();
    }
    
    window.addEventListener('DOMContentLoaded', () => {
        showStep();
    });
    </script>

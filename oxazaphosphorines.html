<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nitrogen Mustards</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <style>
         .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1a2980;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        
        .sidebar-toggle-icon {
            font-size: 20px;
            color: white;
        }
        
        /* WHITE SIDEBAR STYLES */
        .sidebar {
            width: 280px;
            background: white;
            color: #333;
            padding: 30px 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 999;
            left: -280px;
            top: 0;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.05);
            border-right: 1px solid #eee;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar h2 {
            color: #1a2980;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            font-size: 1.5rem;
        }
        
        /* NAVIGATION LINKS */
        .nav-links {
            list-style: none;
            padding: 0;
        }
        
        .nav-links li {
            margin-bottom: 10px;
        }
        
        .nav-links a {
            color: #555;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.1);
        }

        /* SUBMENU STYLES */
        .sub-links {
            list-style: none;
            padding-left: 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .has-submenu.active .sub-links {
            max-height: 500px;
        }

        .sub-links a {
            padding: 8px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        
        .sub-links a:hover {
            background-color: #f8f9fa;
        }

        .sub-links.active {
            display: block;
        }

        .has-submenu {
            position: relative;
        }

        .has-submenu::after {
            content: '▼';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .has-submenu.active::after {
            transform: translateY(-50%) rotate(180deg);
        }

        
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
        width: 100%;
        height: 100%;
        font-family: 'Arial', sans-serif;
        color: #333;
        line-height: 1.6;
        scroll-behavior: smooth;
        background: #f5f7fa;
        }

        body {
            overflow-x: hidden;
            overflow-y: auto;
            margin: 0;
        }

        .scene {
            min-height: auto;
            height:auto;
            padding: 80px 40px;
            margin-bottom: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            max-width: 1000px;
            margin: 60px auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: visible;
        }

        .header {
            text-align: center;
            padding: 80px 20px 60px;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            position: relative;
            z-index: 10;
            clip-path: polygon(0 0, 100% 0, 100% 90%, 0 100%);
            margin-bottom: -30px;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.3rem;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .sidebar-expanded .main-content {
                position: fixed;
                left: 250px;
                width: 100%;
            }
            
            .sidebar-expanded::after {
                content: '';
                position: fixed;
                top: 0;
                left: 250px;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 998;
            }
        }

        @media (max-width: 576px) {
            .header {
                padding: 60px 20px 40px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .team-members {
                padding: 20px;
                margin-bottom: 40px;
            }
            
            .scene {
                padding: 40px 20px;
                margin: 30px auto;
            }
            
            .scene h2 {
                font-size: 1.5rem;
            }
            
            .battlefield, .lab, .dna-animation, .treatment-scene {
                height: 280px;
            }
            
            .drug-types {
                gap: 15px;
            }
            
            .drug-card {
                width: 140px;
                height: 140px;
            }
            
            .drug-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .drug-card h4 {
                font-size: 16px;
                margin: 10px 0 5px;
            }
            
            .chemical-structure {
                height: 120px;
                margin: 30px 0;
            }
            
            .footer {
                padding: 60px 20px;
            }
            
            .footer p {
                font-size: 1.1rem;
            }
        }

    
        .drug-card {
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .drug-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .drug-card-link {
            text-decoration: none;
            color: inherit;
        }

        .animation-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 10000;
            white-space: nowrap;
            transform: translate(-50%, -110%);
        }

        .key-points, .activation-pathway {
            background: rgba(245, 245, 245, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #1a2980;
        }

        .comparison-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }

        .comparison-table th, .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table th {
            background-color: #1a2980;
            color: white;
        }

        .comparison-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .molecular-detail {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        @keyframes highlight {
            from { background-color: rgba(100, 200, 255, 0.3); }
            to { background-color: transparent; }
        }

        :target {
            animation: highlight 2s ease;
        }


.scene.chemistry-theme {
            width: 100%;
            padding: 2rem;
            background: 
                url('https://www.transparenttextures.com/patterns/hexellence.png') repeat,
                linear-gradient(135deg, #f0f8ff 0%, #e0f7fa 100%);
            background-blend-mode: overlay;
            box-shadow: inset 0 0 0 1000px rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            border-top: 6px solid #4db6ac;
            border-bottom: 6px solid #4db6ac;
            box-sizing: border-box;

            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            align-items: center; /* ✅ Center content vertically */
            justify-content: center;
        }

        .source-caption {
            text-align: center;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 1.5rem;
        }

        .main-caption {
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
            color: #00796b;
            margin-top: 1rem;
        }

        #img2 {
      display: none;
      margin-top: 10px;
    }

    img {
      cursor: pointer;
      max-width: 200px;
    }

    .scene img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            display: block;
            margin: 0 auto;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .navigation-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
    }
    
    .navigation-buttons button {
        padding: 12px 24px;
        border: none;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .navigation-buttons button:nth-child(1),
    .navigation-buttons button:nth-child(2) {
        background: linear-gradient(135deg, #1a2980, #26d0ce);
        color: white;
    }
    
    .navigation-buttons button:last-child {
        background: linear-gradient(135deg, #ff416c, #ff4b2b);
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .navigation-buttons button:last-child::after {
        content: '↻';
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
    }
    
    .navigation-buttons button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .navigation-buttons button:active {
        transform: translateY(1px);
    }
    
    .navigation-buttons button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    .mechanism-visualization {
            height: 400px;
            position: relative;
            margin: 30px 0;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            border: 1px solid #eee;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .mechanism-visualization::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="1" height="1" fill="%23eee"/></svg>');
            opacity: 0.3;
        }
        
        .molecule-label {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, -50%);
        }
        
        .dna-strand {
            position: absolute;
            width: 300px;
            height: 60px;
            background: linear-gradient(to right, #4CAF50, #8BC34A);
            border-radius: 30px;
            opacity: 0;
            transform: scale(0.8);
        }
        
        .blood-brain-barrier {
            position: absolute;
            width: 100%;
            height: 3px;
            background: #1a2980;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            opacity: 0.7;
        }

    </style>
</head>

<body>
        <!-- Sidebar Toggle Button -->
    <div class="sidebar-toggle" id="sidebarToggle">
        <span class="sidebar-toggle-icon">☰</span>
    </div>

    <div class="sidebar">
        <h2>Navigation</h2>
        <ul class="nav-links">
            <li><a href="historical.html">Warhead and Wonder drugs</a></li>
            <li><a href="mechanism.html">Cellular blueprints</a></li>
            <li class="has-submenu">
                <a href="agents.html">Weapons of the cell war</a>
                <ul class="sub-links">
                  <li><a href="agents.html">Summary</a></li>
                  <li><a href="nitrogen-mustards.html">Nitrogen Mustards</a></li>
                  <li><a href="oxazaphosphorines.html">Oxazaphosphorines</a></li>
                  <li><a href="nitrosoureas.html">Nitrosourea</a></li>
                  <li><a href="mitomycin-c.html">Mitomycin C</a></li>
                </ul>
              </li>
            <li><a href="references.html">References</a></li>
            <li><a href="index.html">Authors</a></li>
        </ul>
    </div>


    <div class="header">
        <h1>From Mustard Gas to Chemotherapy</h1>
        <p>From chemical warfare to cancer cure, the alchemical evolution of chemotherapy drugs</p>
    </div>

    <div class="scene">
        <h2>Oxazaphosphorines</h2>
    </div>

    <div class="scene chemistry-theme">
        <figure>

            <img src="oxaza1.png" alt="Oxazaphosphorines 1">
            <!--<figcaption class="main-caption">Nitrogen Mustard Activation Pathway</figcaption>-->
            <figcaption class="source-caption">
                <i>Credit to WHERE IS THE SOURCE!!! </i>
    
            </figcaption>
        </figure>
        <p class="description">
            <strong>Cyclophosphamide (CP)</strong> is hydroxylated by P450 enzymes in the liver (Cytochrome P450) to <strong>4-hydroxycyclophosphamide (OHCP)</strong>.
        </p>
    </div>

    <div class="scene chemistry-theme">
        <figure>

            <img src="oxaza2.png" alt="Oxazaphosphorines 2">
            <!--<figcaption class="main-caption">Nitrogen Mustard Activation Pathway</figcaption>-->
            <figcaption class="source-caption">
                <i>Credit to WHERE IS THE SOURCE!!! </i>
    
            </figcaption>
        </figure>
        <p class="description">
            4-hydroxycyclophosphamide has a tautomer that is created in the process called Aldophosphamide (ALDO).
        </p>
    </div>

    <div class="scene chemistry-theme">
        <figure>

            <img src="oxaza3.png" alt="Oxazaphosphorines 3">
            <!--<figcaption class="main-caption">Nitrogen Mustard Activation Pathway</figcaption>-->
            <figcaption class="source-caption">
                <i>Credit to WHERE IS THE SOURCE!!! </i>
    
            </figcaption>
        </figure>
        <p class="description">
            Aldophosphamide is decomposed by Phosphodiesterases (PDE) to form Phosphamide Mustard (PAM) through the β-elimination reaction
        </p>
    </div>

    <div class="scene chemistry-theme">
        <figure>

            <img src="https://2.wlimg.com/product_images/bc-full/2018/10/5382728/cyclophosphamide-injection-1538722219-4056054.jpeg" alt="Cyclophosphamide">
            <figcaption class="main-caption">Cyclophosphamide</figcaption>
            <figcaption class="source-caption">
                <i>Credit to WLimg. (n.d.). [Image of cyclophosphamide injection]</i>
            </figcaption>
        </figure>
        <p class="description">
            <ul>
            <li>Drugs under the oxazaphosphorine class include Ifosfamide and Cyclophosphamide</li>

            <li>Oxazaphosphamides drugs are commonly used to treat sarcoma and other solid tumors</li>
            
            </ul>
            
        </p>
    </div>



    <div class="scene" id="oxazaphosphorine-mechanism">
    <h2>Oxazaphosphorine Animation</h2>
    <div class="mechanism-visualization" style="display: flex; justify-content: center; align-items: center;">
         <svg id="ox-animation" width="500" height="280" viewBox="0 0 500 280"></svg>
    </div>
    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background: #007bff;"></div><span>5'-3' Backbone (Blue)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #dc3545;"></div><span>3'-5' Backbone (Red)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #F08080;"></div><span>Adenine (A)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #F5D67D;"></div><span>Thymine (T)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #58D68D;"></div><span>Guanine (G)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #5DADE2;"></div><span>Cytosine (C)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #BDC3C7;"></div><span>Hydrogen Bonds</span></div>
    </div>
    <div class="explanation-box">
        <h3 id="ox-step-title">Oxazaphosphorine: Step 1</h3>
        <p class="explanation-text" id="ox-explanation"></p>
    </div>
    <div class="navigation-buttons">
        <button id="ox-prev-btn" onclick="navigateTo('previous', 'oxazaphosphorine')">Previous</button>
        <button id="ox-next-btn" onclick="navigateTo('next', 'oxazaphosphorine')">Next</button>
        <button onclick="navigateTo('restart', 'oxazaphosphorine')">Restart</button>
    </div>
</div>

<script>
    const svgNS = "http://www.w3.org/2000/svg";
    
    // Utility to create a labeled circle molecule
    function createMolecule(svg, id, x, y, color, label, r = 32) {
        const group = document.createElementNS(svgNS, "g");
        // Main circle
        const circle = document.createElementNS(svgNS, "circle");
        circle.setAttribute("id", id + "-circle");
        circle.setAttribute("cx", x);
        circle.setAttribute("cy", y);
        circle.setAttribute("r", r);
        circle.setAttribute("fill", color);
        circle.setAttribute("stroke", "#333");
        circle.setAttribute("stroke-width", "3");
        group.appendChild(circle);
        // Label
        const txt = document.createElementNS(svgNS, "text");
        txt.setAttribute("x", x);
        txt.setAttribute("y", y + 6);
        txt.setAttribute("font-size", "13px");
        txt.setAttribute("text-anchor", "middle");
        txt.setAttribute("fill", "white");
        txt.setAttribute("font-weight", "bold");
        txt.textContent = label.replace(/\n/g, ' ');
        group.appendChild(txt);
        svg.appendChild(group);
        return { group, circle, label: txt };
    }
    // Utility to create a liver rectangle with label
    function createLiver(svg, id, x, y) {
        const rect = document.createElementNS(svgNS, "rect");
        rect.setAttribute("x", x);
        rect.setAttribute("y", y);
        rect.setAttribute("width", 70);
        rect.setAttribute("height", 38);
        rect.setAttribute("fill", "#9477b3");
        rect.setAttribute("rx", 18);
        rect.setAttribute("stroke", "#333");
        rect.setAttribute("stroke-width", "2");
        svg.appendChild(rect);
        const txt = document.createElementNS(svgNS, "text");
        txt.setAttribute("x", x + 35);
        txt.setAttribute("y", y + 24);
        txt.setAttribute("font-size", "16px");
        txt.setAttribute("text-anchor", "middle");
        txt.setAttribute("fill", "white");
        txt.setAttribute("font-weight", "bold");
        txt.textContent = "Liver";
        svg.appendChild(txt);
        return { rect, label: txt };
    }
    // Utility to draw arrow
    function createArrow(svg, x1, y1, x2, y2, color = "#333") {
        const arrow = document.createElementNS(svgNS, "line");
        arrow.setAttribute("x1", x1);
        arrow.setAttribute("y1", y1);
        arrow.setAttribute("x2", x2);
        arrow.setAttribute("y2", y2);
        arrow.setAttribute("stroke", color);
        arrow.setAttribute("stroke-width", "5");
        arrow.setAttribute("marker-end", "url(#arrowhead)");
        svg.appendChild(arrow);
        return arrow;
    }
    // Clear SVG and add marker
    function clearSVG(id) {
        const svg = document.getElementById(id);
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        let defs = document.createElementNS(svgNS, 'defs');
        let marker = document.createElementNS(svgNS, 'marker');
        marker.setAttribute('id', 'arrowhead');
        marker.setAttribute('markerWidth', '10');
        marker.setAttribute('markerHeight', '7');
        marker.setAttribute('refX', '10');
        marker.setAttribute('refY', '3.5');
        marker.setAttribute('orient', 'auto');
        let arrowPath = document.createElementNS(svgNS, 'polygon');
        arrowPath.setAttribute('points', '0 0, 10 3.5, 0 7');
        arrowPath.setAttribute('fill', '#333');
        marker.appendChild(arrowPath);
        defs.appendChild(marker);
        svg.appendChild(defs);
    }
    
    function showAnimationTooltip(evt, html) {
        let tooltip = document.getElementById('dna-tooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'dna-tooltip';
            tooltip.style.position = 'fixed';
            tooltip.style.zIndex = '9999';
            tooltip.style.background = 'rgba(255,255,255,0.95)';
            tooltip.style.border = '1px solid #888';
            tooltip.style.borderRadius = '6px';
            tooltip.style.padding = '8px 12px';
            tooltip.style.pointerEvents = 'none';
            tooltip.style.fontSize = '13px';
            tooltip.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
            document.body.appendChild(tooltip);
        }
        tooltip.innerHTML = html;
        tooltip.style.display = 'block';
        tooltip.style.left = `${evt.clientX + 12}px`;
        tooltip.style.top = `${evt.clientY - 10}px`;
    }
    function hideAnimationTooltip() {
        const tooltip = document.getElementById('dna-tooltip');
        if (tooltip) tooltip.style.display = 'none';
    }
    
    // DNA helix and bond helpers as defined in your original script
    function createLabel(svg, id, x, y, text) {
        const label = document.createElementNS(svgNS, "text");
        label.setAttribute("id", id);
        label.setAttribute("x", x);
        label.setAttribute("y", y);
        label.setAttribute("dominant-baseline", "middle");
        label.setAttribute("text-anchor", "middle");
        label.textContent = text;
        svg.appendChild(label);
        return label;
    }
    function createDetailedDNAStrands(svg, idPrefix, x_center, y_offset, overall_height, numSegments = 5) {
        const group = document.createElementNS(svgNS, 'g');
        group.setAttribute('id', `${idPrefix}-dna-helix`);
        svg.appendChild(group);
    
        const amplitude = 40;
        const frequency = 0.025;
        const segmentStep = 2;
    
        const backboneColorBlue = '#007bff';
        const backboneColorRed = '#dc3545';
        const adenineColor = '#F08080';
        const thymineColor = '#F5D67D';
        const guanineColor = '#58D68D';
        const cytosineColor = '#5DADE2';
        const hBondColor = '#BDC3C7';
        const labelColor = '#333';
    
        const backboneWidth = 5;
        const baseRectWidthPurine = 18;
        const baseRectHeightPurine = 10;
        const baseRectWidthPyrimidine = 14;
        const baseRectHeightPyrimidine = 10;
        const baseFontSize = "8px";
    
        const allElements = [];
        const sequence = ['A', 'T', 'G', 'C', 'G', 'T', 'A', 'C', 'G', 'A'];
        const numBasePairs = sequence.length;
        const basePairSpacing = overall_height / (numBasePairs + 1);
    
        const strandBlue = document.createElementNS(svgNS, 'path');
        const strandRed = document.createElementNS(svgNS, 'path');
        let dBlue = '';
        let dRed = '';
        const startY = y_offset;
        const endY = y_offset + overall_height;
    
        for (let currentY = startY; currentY <= endY; currentY += segmentStep) {
            const xBlue = x_center - amplitude * Math.cos(frequency * (currentY - startY));
            const xRed  = x_center - amplitude * Math.cos(frequency * (currentY - startY) + Math.PI);
            if (currentY === startY) {
                dBlue += `M${xBlue},${currentY}`;
                dRed += `M${xRed},${currentY}`;
            } else {
                dBlue += ` L${xBlue},${currentY}`;
                dRed += ` L${xRed},${currentY}`;
            }
        }
        strandBlue.setAttribute('d', dBlue);
        strandBlue.setAttribute('stroke', backboneColorBlue);
        strandBlue.setAttribute('stroke-width', backboneWidth);
        strandBlue.setAttribute('fill', 'none');
        strandBlue.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>5\'-3\' DNA Backbone</b><br>(Blue Strand)'));
        strandBlue.addEventListener('mouseleave', hideAnimationTooltip);
        group.appendChild(strandBlue);
        allElements.push(strandBlue);
    
        strandRed.setAttribute('d', dRed);
        strandRed.setAttribute('stroke', backboneColorRed);
        strandRed.setAttribute('stroke-width', backboneWidth);
        strandRed.setAttribute('fill', 'none');
        strandRed.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>3\'-5\' DNA Backbone</b><br>(Red Strand)'));
        strandRed.addEventListener('mouseleave', hideAnimationTooltip);
        group.appendChild(strandRed);
        allElements.push(strandRed);
    
        const fivePrimeBlue = createLabel(svg, `${idPrefix}-5pb`, x_center - amplitude - 15, startY, "5'");
        const threePrimeBlue = createLabel(svg, `${idPrefix}-3pb`, x_center - amplitude * Math.cos(frequency * overall_height) - 15, endY + 15, "3'");
        const threePrimeRed = createLabel(svg, `${idPrefix}-3pr`, x_center - amplitude * Math.cos(Math.PI) + 15, startY, "3'");
        const fivePrimeRed = createLabel(svg, `${idPrefix}-5pr`, x_center - amplitude * Math.cos(frequency * overall_height + Math.PI) + 15, endY + 15, "5'");
        if (window.gsap) {
            gsap.set([fivePrimeBlue, threePrimeBlue, threePrimeRed, fivePrimeRed], {opacity: 1, fill: labelColor, fontSize: "12px", fontWeight:"bold"});
        }
        allElements.push(fivePrimeBlue, threePrimeBlue, threePrimeRed, fivePrimeRed);
    
        const guaninePositions = [];
        for (let i = 0; i < numBasePairs; i++) {
            const currentY = y_offset + (i + 1) * basePairSpacing;
            const xBlue = x_center - amplitude * Math.cos(frequency * (currentY - startY));
            const xRed  = x_center - amplitude * Math.cos(frequency * (currentY - startY) + Math.PI);
    
            const baseTypeStrand1 = sequence[i];
            let baseTypeStrand2, color1, color2, width1, height1, width2, height2, label1, label2;
            let tooltip1, tooltip2;
    
            switch (baseTypeStrand1) {
                case 'A':
                    baseTypeStrand2 = 'T'; color1 = adenineColor; color2 = thymineColor;
                    width1 = baseRectWidthPurine; height1 = baseRectHeightPurine;
                    width2 = baseRectWidthPyrimidine; height2 = baseRectHeightPyrimidine;
                    label1 = 'A'; label2 = 'T';
                    tooltip1 = '<b>Adenine (A)</b>'; tooltip2 = '<b>Thymine (T)</b>';
                    break;
                case 'T':
                    baseTypeStrand2 = 'A'; color1 = thymineColor; color2 = adenineColor;
                    width1 = baseRectWidthPyrimidine; height1 = baseRectHeightPyrimidine;
                    width2 = baseRectWidthPurine; height2 = baseRectHeightPurine;
                    label1 = 'T'; label2 = 'A';
                    tooltip1 = '<b>Thymine (T)</b>'; tooltip2 = '<b>Adenine (A)</b>';
                    break;
                case 'G':
                    baseTypeStrand2 = 'C'; color1 = guanineColor; color2 = cytosineColor;
                    width1 = baseRectWidthPurine; height1 = baseRectHeightPurine;
                    width2 = baseRectWidthPyrimidine; height2 = baseRectHeightPyrimidine;
                    label1 = 'G'; label2 = 'C';
                    tooltip1 = '<b>Guanine (G)</b><br>Target for alkylation.'; tooltip2 = '<b>Cytosine (C)</b>';
                    break;
                case 'C':
                    baseTypeStrand2 = 'G'; color1 = cytosineColor; color2 = guanineColor;
                    width1 = baseRectWidthPyrimidine; height1 = baseRectHeightPyrimidine;
                    width2 = baseRectWidthPurine; height2 = baseRectHeightPurine;
                    label1 = 'C'; label2 = 'G';
                    tooltip1 = '<b>Cytosine (C)</b>'; tooltip2 = '<b>Guanine (G)</b><br>Target for alkylation.';
                    break;
            }
            const base1 = document.createElementNS(svgNS, 'rect');
            base1.setAttribute('id', `${idPrefix}-base1-${i}`);
            base1.setAttribute('x', xBlue - width1/2);
            base1.setAttribute('y', currentY - height1/2);
            base1.setAttribute('width', width1);
            base1.setAttribute('height', height1);
            base1.setAttribute('fill', color1);
            base1.setAttribute('rx', 2); base1.setAttribute('ry', 2);
            base1.addEventListener('mouseenter', (e) => showAnimationTooltip(e, tooltip1));
            base1.addEventListener('mouseleave', hideAnimationTooltip);
            group.appendChild(base1);
            allElements.push(base1);
    
            const baseLabel1 = createLabel(svg, `${idPrefix}-b1label-${i}`, xBlue, currentY + 2, label1);
            if (window.gsap) {
                gsap.set(baseLabel1, {opacity:1, fill:"white", fontSize: baseFontSize, pointerEvents: 'none'});
            }
            allElements.push(baseLabel1);
    
            const base2 = document.createElementNS(svgNS, 'rect');
            base2.setAttribute('id', `${idPrefix}-base2-${i}`);
            base2.setAttribute('x', xRed - width2/2);
            base2.setAttribute('y', currentY - height2/2);
            base2.setAttribute('width', width2);
            base2.setAttribute('height', height2);
            base2.setAttribute('fill', color2);
            base2.setAttribute('rx', 2); base2.setAttribute('ry', 2);
            base2.addEventListener('mouseenter', (e) => showAnimationTooltip(e, tooltip2));
            base2.addEventListener('mouseleave', hideAnimationTooltip);
            group.appendChild(base2);
            allElements.push(base2);
    
            const baseLabel2 = createLabel(svg, `${idPrefix}-b2label-${i}`, xRed, currentY + 2, label2);
            if (window.gsap) {
                gsap.set(baseLabel2, {opacity:1, fill:"white", fontSize: baseFontSize, pointerEvents: 'none'});
            }
            allElements.push(baseLabel2);
    
            const hBond = document.createElementNS(svgNS, 'line');
            hBond.setAttribute('x1', xBlue);
            hBond.setAttribute('y1', currentY);
            hBond.setAttribute('x2', xRed);
            hBond.setAttribute('y2', currentY);
            hBond.setAttribute('stroke', hBondColor);
            hBond.setAttribute('stroke-width', '2');
            hBond.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Hydrogen Bonds</b>'));
            hBond.addEventListener('mouseleave', hideAnimationTooltip);
            group.appendChild(hBond);
            allElements.push(hBond);
    
            if (baseTypeStrand1 === 'G') {
                base1.dataset.n7x = xBlue + (width1 / 2) * 0.6;
                base1.dataset.n7y = currentY;
                guaninePositions.push({
                    element: base1,
                    n7: { x: xBlue + (width1 / 2) * 0.6, y: currentY },
                    index: i,
                    strand: 1
                });
            }
            if (baseTypeStrand2 === 'G') {
                base2.dataset.n7x = xRed - (width2 / 2) * 0.6;
                base2.dataset.n7y = currentY;
                guaninePositions.push({
                    element: base2,
                    n7: { x: xRed - (width2 / 2) * 0.6, y: currentY },
                    index: i,
                    strand: 2
                });
            }
        }
        if (window.gsap) {
            gsap.set(allElements, { opacity: 0, scale: 0.9, transformOrigin: "center center" });
            gsap.to(allElements, { opacity: 1, scale: 1, stagger: 0.03, duration: 0.7, ease: "power2.out" });
        }
        return {
            group,
            elements: allElements,
            path1: strandBlue,
            path2: strandRed,
            getGuaninePositions: () => guaninePositions
        };
    }
    function createBond(svg, id, x1, y1, x2, y2, color = "#FBC02D", width = 4) {
        const line = document.createElementNS(svgNS, "line");
        line.setAttribute("id", id);
        line.setAttribute("x1", x1);
        line.setAttribute("y1", y1);
        line.setAttribute("x2", x2);
        line.setAttribute("y2", y2);
        line.setAttribute("stroke", color);
        line.setAttribute("stroke-width", width);
        svg.appendChild(line);
        return line;
    }
    
    const stepExplanations = [
        "1. Cyclophosphamide (inactive prodrug) circulates in the blood. It must be activated in the liver.",
        "2. Liver CYP450 enzymes convert cyclophosphamide into 4-hydroxycyclophosphamide (OHCP) and Aldophosphamide (ALDO).",
        "3. Aldophosphamide (ALDO) breaks down into the active drug, Phosphoramide Mustard (PM), and the toxic byproduct Acrolein.",
        "4. Phosphoramide Mustard (PM) alkylates the guanine (G) base on DNA, forming a covalent bond.",
        "5. A second alkylation links to another guanine (G) on the opposite DNA strand, causing a cytotoxic cross-link."
    ];
    
    // FULL ANIMATION STEPS
    const improvedAnimations = [
        // Step 1: Cyclophosphamide in blood
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            const cp = createMolecule(svg, 'cp', 100, 140, '#1976D2', 'Cyclophosphamide', 36);
            gsap.set([cp.circle, cp.label], { opacity: 0 });
            gsap.to([cp.circle, cp.label], { opacity: 1, duration: 0.8 });
        },
        // Step 2: Activation in liver
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            const cp = createMolecule(svg, 'cp', 100, 140, '#1976D2', 'Cyclophosphamide', 36);
            const liver = createLiver(svg, 'liver', 200, 110);
            const arrow = createArrow(svg, 136, 140, 200, 129, "#333");
            const ohcp = createMolecule(svg, 'ohcp', 340, 120, '#43A047', 'OHCP', 24);
            const aldo = createMolecule(svg, 'aldo', 340, 180, '#FBC02D', 'ALDO', 24);
            gsap.set([cp.circle, cp.label, liver.rect, liver.label, arrow, ohcp.circle, ohcp.label, aldo.circle, aldo.label], { opacity: 0 });
            let tl = gsap.timeline();
            tl.to([cp.circle, cp.label], { opacity: 1, duration: 0.6 })
              .to([liver.rect, liver.label], { opacity: 1, duration: 0.5 }, "-=0.3")
              .to([arrow], { opacity: 1, duration: 0.4 }, "-=0.3")
              .to([ohcp.circle, ohcp.label, aldo.circle, aldo.label], { opacity: 1, duration: 0.5, stagger: 0.1 });
        },
        // Step 3: Formation of PM and Acrolein
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            const aldo = createMolecule(svg, 'aldo', 120, 140, '#FBC02D', 'ALDO', 32);
            const arrow = createArrow(svg, 152, 140, 210, 140, "#333");
            const pm = createMolecule(svg, 'pm', 270, 110, '#D81B60', 'PM', 28);
            const acrolein = createMolecule(svg, 'acr', 270, 180, '#BDB76B', 'Acrolein', 22);
            gsap.set([aldo.circle, aldo.label, arrow, pm.circle, pm.label, acrolein.circle, acrolein.label], { opacity: 0 });
            let tl = gsap.timeline();
            tl.to([aldo.circle, aldo.label], { opacity: 1, duration: 0.6 })
              .to([arrow], { opacity: 1, duration: 0.4 })
              .to([pm.circle, pm.label, acrolein.circle, acrolein.label], { opacity: 1, duration: 0.5, stagger: 0.1 });
        },
        // Step 4: PM and DNA - first alkylation
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            const pm = createMolecule(svg, 'pm', 120, 140, '#D81B60', 'Phosphoramide\nMustard', 36);
            const dna = createDetailedDNAStrands(svg, 'dna-ox', 320, 30, 200, 8);
            const guanines = dna.getGuaninePositions();
            // First guanine
            const g1 = guanines[0];
            const bond = createBond(svg, 'bond', 120+36, 140, g1.n7.x, g1.n7.y, "#FBC02D", 5);
            gsap.set([pm.circle, pm.label, ...dna.elements, bond], {opacity: 0});
            let tl = gsap.timeline();
            tl.to([pm.circle, pm.label], {opacity: 1, duration: 0.5})
              .to(dna.elements, {opacity: 1, duration: 0.7, stagger: 0.02}, "-=0.2")
              .to(bond, {opacity: 1, duration: 0.5});
        },
        // Step 5: DNA crosslink
        function() {
            clearSVG('ox-animation');
            const svg = document.getElementById('ox-animation');
            const dna = createDetailedDNAStrands(svg, 'dna-ox', 250, 30, 200, 8);
            const guanines = dna.getGuaninePositions();
            const g1 = guanines[0];
            const g2 = guanines[1] || guanines[2];
            const crosslink = createBond(svg, 'crosslink', g1.n7.x, g1.n7.y, g2.n7.x, g2.n7.y, "#D32F2F", 7);
            gsap.set([...dna.elements, crosslink], {opacity: 0});
            let tl = gsap.timeline();
            tl.to(dna.elements, {opacity: 1, duration: 0.7, stagger: 0.02})
              .to(crosslink, {opacity: 1, duration: 0.7});
        }
    ];
    
    // Navigation logic
    let currentStep = 0;
    function updateExplanation() {
        document.getElementById('ox-explanation').innerText = stepExplanations[currentStep];
        document.getElementById('ox-step-title').innerText = "Oxazaphosphorine: Step " + (currentStep + 1);
    }
    function showStep() {
        improvedAnimations[currentStep]();
        updateExplanation();
        document.getElementById('ox-prev-btn').disabled = currentStep === 0;
        document.getElementById('ox-next-btn').disabled = currentStep === improvedAnimations.length-1;
    }
    function navigateTo(action) {
        if (action === "next" && currentStep < improvedAnimations.length-1) currentStep++;
        else if (action === "previous" && currentStep > 0) currentStep--;
        else if (action === "restart") currentStep = 0;
        showStep();
    }
    
    // Sidebar toggle and submenu logic
    document.addEventListener("DOMContentLoaded", function() {
        // Sidebar
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        sidebarToggle.addEventListener('click', function () {
            sidebar.classList.toggle('active');
            document.body.classList.toggle('sidebar-expanded');
        });
        document.querySelectorAll('.has-submenu > a').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                this.parentElement.classList.toggle('active');
            });
        });
        // Animation start
        showStep();
    });
    </script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Learn about alkylating agents and their role in chemotherapy treatment">
    <meta property="og:title" content="Alkylating Agents in Chemotherapy">
    <meta property="og:description" content="Comprehensive guide to alkylating agents and their mechanism of action">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/alkylating-agents">
    <meta property="og:image" content="https://example.com/images/chemotherapy.jpg">
    <title>Alkylating Agents</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <style>
        /* Loading state */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f7fa;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #1a2980;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Main content container */
        .main-content {
            transition: margin-left 0.3s ease;
            margin-left: 0;
            min-height: 100vh;
        }
        
        .sidebar-expanded .main-content {
            margin-left: 280px;
        }
        
        @media (max-width: 768px) {
            .sidebar-expanded .main-content {
                margin-left: 0;
                position: fixed;
                left: 250px;
                width: calc(100% - 250px);
            }
        }

        /* Footer styles */
        .footer {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            padding: 40px 20px;
            text-align: center;
            margin-top: 60px;
        }
        
        .footer p {
            margin: 10px 0;
            font-size: 1.2rem;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .footer-links a {
            color: white;
            text-decoration: none;
            transition: opacity 0.3s;
        }
        
        .footer-links a:hover {
            opacity: 0.8;
        }

        /* Rest of your existing styles... */
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1a2980;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        
        .sidebar-toggle-icon {
            font-size: 20px;
            color: white;
        }
        
        /* WHITE SIDEBAR STYLES */
        .sidebar {
            width: 280px;
            background: white;
            color: #333;
            padding: 30px 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 999;
            left: -280px;
            top: 0;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.05);
            border-right: 1px solid #eee;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar h2 {
            color: #1a2980;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            font-size: 1.5rem;
        }
        
        /* NAVIGATION LINKS */
        .nav-links {
            list-style: none;
            padding: 0;
        }
        
        .nav-links li {
            margin-bottom: 10px;
        }
        
        .nav-links a {
            color: #555;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.1);
        }

        /* SUBMENU STYLES */
        .sub-links {
            list-style: none;
            padding-left: 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .has-submenu.active .sub-links {
            max-height: 500px;
        }

        .sub-links a {
            padding: 8px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        
        .sub-links a:hover {
            background-color: #f8f9fa;
        }

        .sub-links.active {
            display: block;
        }

        .has-submenu {
            position: relative;
        }


        .has-submenu .submenu {
            position: absolute; /* Positions relative to .has-submenu */
            top: 100%; /* Places the submenu right below the parent */
            left: 0;
            display: none; /* Hide by default (for dropdowns) */
        }

        .has-submenu::after {
            content: '▼';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .has-submenu.active::after {
            transform: translateY(-50%) rotate(180deg);
        }

        
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
        width: 100%;
        height: 100%;
        font-family: 'Arial', sans-serif;
        color: #333;
        line-height: 1.6;
        scroll-behavior: smooth;
        background: #f5f7fa;
        }

        body {
            overflow-x: hidden;
            overflow-y: auto;
            margin: 0;
        }

        .scene {
            min-height: auto;
            height:auto;
            padding: 80px 40px;
            margin-bottom: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            max-width: 1000px;
            margin: 60px auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: visible;
        }

        .header {
            text-align: center;
            padding: 80px 20px 60px;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            position: relative;
            z-index: 10;
            clip-path: polygon(0 0, 100% 0, 100% 90%, 0 100%);
            margin-bottom: -30px;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.3rem;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.9;
        }


        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .sidebar-expanded .main-content {
                position: fixed;
                left: 250px;
                width: 100%;
            }
            
            .sidebar-expanded::after {
                content: '';
                position: fixed;
                top: 0;
                left: 250px;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 998;
            }
        }

        @media (max-width: 576px){
            
            .scene {
                padding: 40px 20px;
                margin: 30px auto;
            }
            
            .scene h2 {
                font-size: 1.5rem;
            }
            
            .battlefield, .lab, .dna-animation, .treatment-scene {
                height: 280px;
            }
            
            .drug-types {
                gap: 15px;
            }
            
            .drug-card {
                width: 140px;
                height: 140px;
            }
            
            .drug-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .drug-card h4 {
                font-size: 16px;
                margin: 10px 0 5px;
            }
            
            .chemical-structure {
                height: 120px;
                margin: 30px 0;
            }
            
            .footer {
                padding: 30px 20px;
            }
            
            .footer p {
                font-size: 1rem;
            }
        }


    /* Drug Types */
    .drug-types {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: stretch; /* This ensures all cards stretch to same height */
            gap: 30px;
            margin: 50px 0;
        }
        
        .drug-card {
            width: 200px;
            min-height: 200px; /* Changed from height to min-height for flexibility */
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            opacity: 1;
            transform: translateY(0);
            cursor: pointer;
            flex: 1 0 auto; /* Allows cards to grow if content is larger */
        }
        
        .drug-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #26d0ce, #1a2980);
        }
        
        .drug-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .drug-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #26d0ce, #1a2980);
            border-radius: 50%;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 28px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .drug-card h4 {
            margin: 15px 0 8px;
            color: #1a2980;
            text-align: center;
            font-size: 20px;
        }
        
        .drug-card p {
            margin: 0;
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        
        /* Treatment Scene */
        .treatment-scene {
            width: 100%;
            height: 450px;
            background: #e0f7fa;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin: 30px 0;
            background-image: linear-gradient(to bottom, #e0f7fa 0%, #b2ebf2 100%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .hospital-bed {
            position: absolute;
            width: 220px;
            height: 40px;
            background: #a69b97;
            bottom: 0;
            left: 30%;
            border-radius: 5px 5px 0 0;
            box-shadow: inset 0 -10px 20px rgba(0,0,0,0.1);
        }
        
        .hospital-bed::before {
            content: '';
            position: absolute;
            width: 240px;
            height: 15px;
            background: #8d7b75;
            bottom: 40px;
            left: -10px;
            border-radius: 5px;
        }
        
        .hospital-bed::after {
            content: '';
            position: absolute;
            width: 200px;
            height: 10px;
            background: #bcaaa4;
            bottom: 55px;
            left: 10px;
        }
        
        .patient {
            position: absolute;
            width: 80px;
            height: 160px;
            background: #b39ddb;
            bottom: 40px;
            left: 35%;
            border-radius: 40px 40px 0 0;
            opacity: 0;
            z-index: 2;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .patient::before {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            background: #b39ddb;
            top: -20px;
            left: 20px;
            border-radius: 50%;
        }
        
        .patient::after {
            content: '';
            position: absolute;
            width: 35px;
            height: 35px;
            background: #f8bbd0;
            top: -17px;
            left: 23px;
            border-radius: 50%;
        }
        
        .iv-bag {
            position: absolute;
            width: 70px;
            height: 100px;
            background: #80deea;
            top: 60px;
            right: 30%;
            border-radius: 10px;
            opacity: 0;
            z-index: 2;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .iv-bag::before {
            content: '';
            position: absolute;
            width: 40px;
            height: 20px;
            background: #4dd0e1;
            top: -12px;
            left: 15px;
            border-radius: 5px;
        }
        
        .iv-tube {
            position: absolute;
            width: 8px;
            height: 150px;
            background: #4dd0e1;
            top: 160px;
            right: 35%;
            transform-origin: top center;
            opacity: 0;
            z-index: 1;
        }
        
        .iv-tube::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: #4dd0e1;
            bottom: 0;
            left: -2px;
            border-radius: 50%;
        }
        
        .cancer-cell {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #f44336;
            border-radius: 50%;
            opacity: 0;
            filter: drop-shadow(0 0 5px rgba(244, 67, 54, 0.7));
            z-index: 3;
            transition: all 0.5s ease;
        }
        
        .cancer-cell::before, .cancer-cell::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #e53935;
            border-radius: 50%;
        }
        
        .cancer-cell::before {
            top: -12px;
            left: -12px;
        }
        
        .cancer-cell::after {
            bottom: -12px;
            right: -12px;
        }
        
        .healthy-cell {
            position: absolute;
            width: 35px;
            height: 35px;
            background: #4caf50;
            border-radius: 50%;
            opacity: 0;
            filter: drop-shadow(0 0 3px rgba(76, 175, 80, 0.5));
            z-index: 2;
        }
        
        /* Chemical structures */
        .chemical-structure {
            width: 100%;
            height: auto;
            flex-shrink:0;
            position: relative;
            margin: 40px 0;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .chemical-structure::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="1" height="1" fill="%23eee"/></svg>');
            opacity: 0.5;
        }
        
        .atom {
            position: absolute;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            z-index: 2;
        }
        
        .bond {
            position: absolute;
            height: 3px;
            background: #555;
            transform-origin: left center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1;
        }
        
        .double-bond {
            position: absolute;
            height: 3px;
            background: #555;
            transform-origin: left center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1;
        }
        
        .double-bond::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 0;
            width: 100%;
            height: 3px;
            background: #555;
        }
        
        /* Tooltip for chemical elements */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
            white-space: nowrap;
        }

        /* Detailed Alkylation Animation */
        .guanine-structure {
            position: absolute;
            width: 80px;
            height: 80px;
            background: #4CAF50;
            border-radius: 10px;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
        }

        .n7-position, .o6-position {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #FF9800;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .n7-position {
            top: 10px;
            left: 10px;
        }

        .o6-position {
            bottom: 10px;
            right: 10px;
        }

        /* Drug Classes Animation */
        .drug-classes {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin: 50px 0;
        }

        .drug-class-card {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .drug-class-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #26d0ce, #1a2980);
        }

        .drug-class-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .drug-class-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #26d0ce, #1a2980);
            border-radius: 50%;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 28px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }

        .drug-class-card h4 {
            margin: 15px 0 8px;
            color: #1a2980;
            text-align: center;
            font-size: 20px;
        }

        .drug-class-card p {
            margin: 0;
            font-size: 14px;
            color: #666;
            text-align: center;
        }

        /* Add hover effects for drug class cards */
        .drug-class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .mitosis-label{
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 18px;
            font-weight: bold;
            
            z-index: 11;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            filter: none !important;
            transform: translate(-50%, -50%);
            top: 50%;
            left: 50%;
            white-space: nowrap;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        .drug-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .navigation-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
    }
    
    .navigation-buttons button {
        padding: 12px 24px;
        border: none;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .navigation-buttons button:nth-child(1),
    .navigation-buttons button:nth-child(2) {
        background: linear-gradient(135deg, #1a2980, #26d0ce);
        color: white;
    }
    
    .navigation-buttons button:last-child {
        background: linear-gradient(135deg, #ff416c, #ff4b2b);
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .navigation-buttons button:last-child::after {
        content: '↻';
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
    }
    
    .navigation-buttons button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .navigation-buttons button:active {
        transform: translateY(1px);
    }
    
    .navigation-buttons button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    .mechanism-visualization {
            height: 400px;
            position: relative;
            margin: 30px 0;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            border: 1px solid #eee;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .mechanism-visualization::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="1" height="1" fill="%23eee"/></svg>');
            opacity: 0.3;
        }
        
        .molecule-label {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, -50%);
        }
        
        .dna-strand {
            position: absolute;
            width: 300px;
            height: 60px;
            background: linear-gradient(to right, #4CAF50, #8BC34A);
            border-radius: 30px;
            opacity: 0;
            transform: scale(0.8);
        }
        
        .blood-brain-barrier {
            position: absolute;
            width: 100%;
            height: 3px;
            background: #1a2980;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            opacity: 0.7;
        }

        /* Update button styles to match mechanism.html */
        .dna-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #1a2980;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .dna-visualization {
            width: 100%;
            height: 400px;
            position: relative;
            margin: 30px 0;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 8px;
        }

         /* Footer */
         .footer {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
        }
        
        .footer p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
    </style>
</head>

<body>

    <!-- Sidebar Toggle Button -->
    <div class="sidebar-toggle" id="sidebarToggle">
        <span class="sidebar-toggle-icon">☰</span>
    </div>

    <div class="sidebar">
        <h2>Navigation</h2>
        <ul class="nav-links">
            <li><a href="overview.html">Authors</a></li>
            <li><a href="historical.html">Historical content - Warhead and Wonder drugs</a></li>
            <li><a href="mechanism.html">Normal DNA Replication - Clean copies</a></li>
            <li class="has-submenu">
                <a href="agents.html">Alkylating Agents</a>
                <ul class="sub-links">
                  <li><a href="agents.html">Summary</a></li>
                  <li><a href="agents.html#nitrogen-mustard">Nitrogen Mustards</a></li>
                  <li><a href="agents.html#oxazaphosphorines">Oxazaphosphorines</a></li>
                  <li><a href="agents.html#nitrosourea">Nitrosourea</a></li>
                  <li><a href="agents.html#mitomycin-c">Mitomycin C</a></li>
                </ul>
              </li>

            <li><a href="references.html">References</a></li>
        </ul>
    </div>


    <!-- Main Content Area -->
    <div class="main-content">
    <div class="header">
        <h1>From Mustard Gas to Chemotherapy</h1>
        <p>The Alchemical Transformation of Chemical Weapons into Life-Saving Medicines</p>
    </div>

    <!-- Chemotherapy Drug Classes -->
    <div class="scene" id="drug-classes">
        <h2>Chemotherapy Drug Classes</h2>
        <div class="drug-types">
            <a href="#nitrogen-mustard-mechanism" class="drug-card-link">
                <div class="drug-card" id="nitrogen-mustard">
                    <div class="drug-icon">N</div>
                    <h4>Nitrogen Mustards</h4>
                    <p>Forms aziridinium ions</p>
                </div>
            </a>
            
            <a href="#nitrosourea-mechanism" class="drug-card-link">
                <div class="drug-card" id="nitrosourea">
                    <div class="drug-icon">NU</div>
                    <h4>Nitrosoureas</h4>
                    <p>Crosses Blood-Brain Barrier</p>
                </div>
            </a>
            
            <a href="#mitomycin-c-mechanism" class="drug-card-link">
                <div class="drug-card" id="mitomycin-c">
                    <div class="drug-icon">M</div>
                    <h4>Mitomycin C</h4>
                    <p>DNA Cross-linking</p>
                </div>
            </a>
            
            <a href="#oxazaphosphorine-mechanism" class="drug-card-link">
                <div class="drug-card" id="oxazaphosphorines">
                    <div class="drug-icon">O</div>
                    <h4>Oxazaphosphorines</h4>
                    <p>Prodrug for Sarcoma</p>
                </div>
            </a>
        </div>

        <h3>Nitrogen Mustards</h3>
        <p>Form aziridinium ions that cross-link DNA strands, preventing cell division and leading to cell death.</p>

        <h3>Nitrosoureas</h3>
        <p>Nitrosoureas (e.g., Carmustine, Lomustine) are notable for their high lipophilicity, allowing them to cross the blood-brain barrier, making them effective against brain tumors. In basic conditions, they decompose to form diazohydroxide and an isocyanate. The diazohydroxide generates a reactive cation that alkylates DNA, primarily at O6 or N7 positions of guanine. The isocyanate can carbamylate proteins, such as DNA repair factors, contributing to cytotoxicity.</p>

        <h3>Oxazaphosphorines</h3>
        <p>Activated in liver to form chloroethylaziridine, a DNA cross-linker. Used for solid tumors.</p>

        <h3>Mitomycin C</h3>
        <p>Enzymatically activated to open aziridine rings, forming DNA cross-links in adenocarcinomas.</p>


    </div>

    <!-- Add the mechanism sections -->
    <div class="scene" id="nitrogen-mustard-mechanism">
        <h2>Nitrogen Mustard Mechanism</h2>
        <div class="mechanism-visualization" style="display: flex; justify-content: center; align-items: center;">
            <svg id="nm-animation" width="500" height="280" viewBox="0 0 500 280"></svg> <!-- SVG content will be dynamic -->
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #007bff;"></div>
                <span>5'-3' Backbone (Blue)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #dc3545;"></div>
                <span>3'-5' Backbone (Red)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F08080;"></div>
                <span>Adenine (A)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F5D67D;"></div>
                <span>Thymine (T)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #58D68D;"></div>
                <span>Guanine (G)</span>
            </div>
             <div class="legend-item">
                <div class="legend-color" style="background: #5DADE2;"></div>
                <span>Cytosine (C)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #BDC3C7;"></div>
                <span>Hydrogen Bonds</span>
            </div>
        </div>
        <div class="explanation-box">
            <h3>Nitrogen Mustard: Step X</h3> 
            <p class="explanation-text" id="nm-explanation"></p> 
            </div>
            <div class="navigation-buttons">
                <button id="nm-prev-btn" onclick="navigateTo('previous', 'nitrogen-mustard')">Previous Step</button>
                <button id="nm-next-btn" onclick="navigateTo('next', 'nitrogen-mustard')">Next Step</button>
                <button onclick="navigateTo('restart', 'nitrogen-mustard')">Restart</button>
        </div>
    </div>

    <!-- Nitrosourea Mechanism -->
    <div class="scene" id="nitrosourea-mechanism">
        <h2>Nitrosourea Mechanism</h2>
        <div class="mechanism-visualization" style="display: flex; justify-content: center; align-items: center;">
             <svg id="nu-animation" width="500" height="280" viewBox="0 0 500 280"></svg>
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #007bff;"></div>
                <span>5'-3' Backbone (Blue)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #dc3545;"></div>
                <span>3'-5' Backbone (Red)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F08080;"></div>
                <span>Adenine (A)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F5D67D;"></div>
                <span>Thymine (T)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #58D68D;"></div>
                <span>Guanine (G)</span>
            </div>
             <div class="legend-item">
                <div class="legend-color" style="background: #5DADE2;"></div>
                <span>Cytosine (C)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #BDC3C7;"></div>
                <span>Hydrogen Bonds</span>
            </div>
        </div>
        <div class="explanation-box"> 
            <h3>Nitrosourea: Step X</h3> 
            <p class="explanation-text" id="nu-explanation"></p> 
        </div>
        <div class="navigation-buttons">
            <button id="nu-prev-btn" onclick="navigateTo('previous', 'nitrosourea')">Previous</button>
            <button id="nu-next-btn" onclick="navigateTo('next', 'nitrosourea')">Next</button>
            <button onclick="navigateTo('restart', 'nitrosourea')">Restart</button>
        </div>
    </div>

    <!-- Oxazaphosphorine Mechanism -->
    <div class="scene" id="oxazaphosphorine-mechanism">
        <h2>Oxazaphosphorine Mechanism</h2>
        <div class="mechanism-visualization" style="display: flex; justify-content: center; align-items: center;">
             <svg id="ox-animation" width="500" height="280" viewBox="0 0 500 280"></svg> <!-- SVG content will be dynamic -->
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #007bff;"></div>
                <span>5'-3' Backbone (Blue)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #dc3545;"></div>
                <span>3'-5' Backbone (Red)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F08080;"></div>
                <span>Adenine (A)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F5D67D;"></div>
                <span>Thymine (T)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #58D68D;"></div>
                <span>Guanine (G)</span>
            </div>
             <div class="legend-item">
                <div class="legend-color" style="background: #5DADE2;"></div>
                <span>Cytosine (C)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #BDC3C7;"></div>
                <span>Hydrogen Bonds</span>
            </div>
        </div>
        <div class="explanation-box">
            <h3>Oxazaphosphorine: Step X</h3> 
            <p class="explanation-text" id="ox-explanation"></p> 
            </div>
            <div class="navigation-buttons">
            <button id="ox-prev-btn" onclick="navigateTo('previous', 'oxazaphosphorine')">Previous</button>
            <button id="ox-next-btn" onclick="navigateTo('next', 'oxazaphosphorine')">Next</button>
                <button onclick="navigateTo('restart', 'oxazaphosphorine')">Restart</button>
        </div>
    </div>

    <!-- Mitomycin C Mechanism -->
    <div class="scene" id="mitomycin-c-mechanism">
        <h2>Mitomycin C Mechanism</h2>
        <div class="mechanism-visualization" style="display: flex; justify-content: center; align-items: center;">
            <svg id="mc-animation" width="500" height="280" viewBox="0 0 500 280"></svg> <!-- SVG content will be dynamic -->
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #007bff;"></div>
                <span>5'-3' Backbone (Blue)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #dc3545;"></div>
                <span>3'-5' Backbone (Red)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F08080;"></div>
                <span>Adenine (A)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F5D67D;"></div>
                <span>Thymine (T)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #58D68D;"></div>
                <span>Guanine (G)</span>
            </div>
             <div class="legend-item">
                <div class="legend-color" style="background: #5DADE2;"></div>
                <span>Cytosine (C)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #BDC3C7;"></div>
                <span>Hydrogen Bonds</span>
            </div>
        </div>
        <div class="explanation-box">
            <h3>Mitomycin C: Step X</h3> 
            <p class="explanation-text" id="mc-explanation"></p> 
            </div>
            <div class="navigation-buttons">
            <button id="mc-prev-btn" onclick="navigateTo('previous', 'mitomycin-c')">Previous</button>
            <button id="mc-next-btn" onclick="navigateTo('next', 'mitomycin-c')">Next</button>
                <button onclick="navigateTo('restart', 'mitomycin-c')">Restart</button>
        </div>
    </div>
</div>
</div>


 
<div class="footer">
    <p>From Chemical Warfare to Cancer Cure: The Alchemical Evolution of Chemotherapy</p>
</div>

<script>

document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.querySelector(".sidebar");
    const sidebarToggle = document.querySelector('.sidebar-toggle');
    const navLinks = document.querySelectorAll(".nav-links a");

    // Sidebar toggle logic
    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', function () {
            sidebar.classList.toggle('active');
            localStorage.setItem('sidebarExpanded', sidebar.classList.contains('active'));
        });

        // Restore state
        if (localStorage.getItem('sidebarExpanded') === 'true') {
            sidebar.classList.add('active');
        }
    }

    // Close sidebar when any link is clicked (including submenu links)
    navLinks.forEach(link => {
        link.addEventListener("click", () => {
            sidebar.classList.remove("active");
            localStorage.setItem('sidebarExpanded', 'false');
        });
    });

    // Submenu toggle - prevent default only for submenu parent links
    const hasSubmenuItems = document.querySelectorAll('.has-submenu');
    hasSubmenuItems.forEach(item => {
        const link = item.querySelector('a');
        const submenuLinks = item.querySelectorAll('.submenu a');
        
        if (link) {
            link.addEventListener('click', function (e) {
                // Only prevent default for the parent link
                if (!e.target.classList.contains('submenu-link')) {
                    e.preventDefault();
                }
                item.classList.toggle('active');
            });
        }

        // Add click handlers for submenu links
        submenuLinks.forEach(subLink => {
            subLink.addEventListener('click', () => {
                sidebar.classList.remove("active");
                localStorage.setItem('sidebarExpanded', 'false');
            });
        });
    });

    function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        // Calculate offset considering fixed header if needed
        const offset = 100; // Adjust this value based on your header height
        const targetPosition = section.getBoundingClientRect().top + window.pageYOffset - offset;
        
        window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
        });
        
        // Update URL without jumping
        history.pushState(null, null, `#${sectionId}`);
    }
}

// Add event listeners for card clicks
document.querySelectorAll('.drug-card-link').forEach(cardLink => {
    cardLink.addEventListener('click', function(e) {
        e.preventDefault();
        const sectionId = this.getAttribute('href').substring(1);
        scrollToSection(sectionId);
    });
});

// Handle hash changes (when user clicks browser back/forward)
window.addEventListener('hashchange', function() {
    const hash = window.location.hash.substring(1);
    if (hash) {
        scrollToSection(hash);
    }
});

        document.querySelectorAll('.drug-card-link').forEach(cardLink => {
            cardLink.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                if (href && href.startsWith('#')) {
                    e.preventDefault(); // Prevent default jump
                    const sectionId = href.substring(1);
                    history.pushState(null, null, href); // Update URL
                    scrollToSection(sectionId);
                }
            });
        });
        
        window.addEventListener('hashchange', handleHashNavigation);
        
        // Tooltip functionality for chemical elements
        document.querySelectorAll('.atom, .dna-base').forEach(element => {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            const elementNames = { 'C': 'Carbon', 'N': 'Nitrogen', 'O': 'Oxygen', 'S': 'Sulfur', 'Cl': 'Chlorine', 'P': 'Phosphorus', 'G': 'Guanine', 'A': 'Adenine', 'T': 'Thymine', /* 'C' for Cytosine is already there */ };
            const symbol = element.textContent.trim();
            const fullName = elementNames[symbol] || symbol;
            tooltip.textContent = `${symbol} (${fullName})`;
            document.body.appendChild(tooltip);
            
            element.addEventListener('mouseenter', (e) => {
                const rect = element.getBoundingClientRect();
                tooltip.style.left = `${rect.left + window.scrollX + rect.width/2 - tooltip.offsetWidth/2}px`;
                tooltip.style.top = `${rect.top + window.scrollY - tooltip.offsetHeight - 5}px`; // 5px offset above
                tooltip.style.opacity = '1';
            });
            
            element.addEventListener('mouseleave', () => {
                tooltip.style.opacity = '0';
        });
    });

        // Animate drug cards on load
        const drugCards = document.querySelectorAll('.drug-card');
        drugCards.forEach((card, index) => {
            gsap.from(card, {
                opacity: 0,
                y: 50,
                duration: 0.5,
                delay: index * 0.15, // Slightly faster stagger
                ease: "power2.out",
                scrollTrigger: { // Trigger animation when card scrolls into view
                    trigger: card.closest('.drug-types') || card, // Use .drug-types as trigger if possible
                    start: "top 80%", // Start when 80% of the card is visible
                    toggleActions: "play none none none", // Play once
                    once: true // Ensure it only plays once
                }
            });
        });

        // Initialize mechanisms (this will also trigger the first step animation)
        Object.keys(mechanisms).forEach(agent => {
            updateMechanism(agent); 
        });
    });

    // --- START OF PREVIOUSLY MODIFIED/KEPT ANIMATION LOGIC ---
    const svgNS = "http://www.w3.org/2000/svg";
    let animationTooltip;

    function showAnimationTooltip(event, text) {
        if (!animationTooltip) {
            animationTooltip = document.getElementById('animationTooltip');
            if (!animationTooltip) return; // Safety check if tooltip element doesn't exist
        }
        animationTooltip.innerHTML = text; // Use innerHTML to allow for bold tags if needed
        animationTooltip.style.display = 'block';
        // Position near mouse, with offset to avoid direct hover interference
        const offsetX = 15;
        const offsetY = 15;
        let x = event.pageX + offsetX;
        let y = event.pageY + offsetY;

        // Keep tooltip within viewport
        if (x + animationTooltip.offsetWidth > window.innerWidth + window.scrollX) {
            x = event.pageX - animationTooltip.offsetWidth - offsetX;
        }
        if (y + animationTooltip.offsetHeight > window.innerHeight + window.scrollY) {
            y = event.pageY - animationTooltip.offsetHeight - offsetY;
        }

        animationTooltip.style.left = `${x}px`;
        animationTooltip.style.top = `${y}px`;
    }

    function hideAnimationTooltip() {
        if (animationTooltip) {
            animationTooltip.style.display = 'none';
        }
    }

    function addArrowheadDef(svgElement) {
        if (!svgElement || svgElement.querySelector("defs #arrowhead")) return; // Avoid duplicates
        const defs = svgElement.querySelector("defs") || document.createElementNS(svgNS, "defs");
        const marker = document.createElementNS(svgNS, "marker");
        marker.setAttribute("id", "arrowhead");
        marker.setAttribute("markerWidth", "10");
        marker.setAttribute("markerHeight", "7");
        marker.setAttribute("refX", "9");
        marker.setAttribute("refY", "3.5");
        marker.setAttribute("orient", "auto-start-reverse");
        const arrowheadPolygon = document.createElementNS(svgNS, "polygon");
        arrowheadPolygon.setAttribute("points", "0 0, 10 3.5, 0 7");
        arrowheadPolygon.setAttribute("fill", "#555"); // Darker arrowhead
        marker.appendChild(arrowheadPolygon);
        defs.appendChild(marker);
        if (!svgElement.querySelector("defs")) {
            svgElement.insertBefore(defs, svgElement.firstChild); // Insert defs at the beginning
        }
    }

    function clearSVG(svgId) {
        const svg = document.getElementById(svgId);
        if (svg) {
            while (svg.lastChild && svg.lastChild.tagName !== 'defs') { // Keep defs if they exist
                 svg.removeChild(svg.lastChild);
            }
            if (!svg.querySelector("defs #arrowhead")){ // If defs were removed or arrowhead is missing
                svg.innerHTML = ''; // Clear completely if defs were an issue
                addArrowheadDef(svg);
            } else if (svg.children.length === 1 && svg.firstChild.tagName === 'defs'){
                 // SVG only contains defs, which is fine
            } else {
                 // Clear children except defs
                let child = svg.lastChild; 
                while (child && child.tagName !== 'defs') { 
                    svg.removeChild(child); 
                    child = svg.lastChild; 
                }
            }
             if (!svg.querySelector("defs #arrowhead")) { // Double check if arrowhead got lost
                addArrowheadDef(svg);
            }
        }
    }
    
    const currentStep = {
        'nitrogen-mustard': 0,
        'oxazaphosphorine': 0,
        'mitomycin-c': 0,
        'nitrosourea': 0 // Added Nitrosourea
    };

    function getAgentDisplayName(agentKey) {
        const names = {
            'nitrogen-mustard': 'Nitrogen Mustard',
            'oxazaphosphorine': 'Oxazaphosphorine',
            'mitomycin-c': 'Mitomycin C',
            'nitrosourea': 'Nitrosourea' // Added Nitrosourea
        };
        return names[agentKey] || agentKey;
    }

    // --- Placeholder for detailed, scientifically accurate animations ---
    // --- We will populate this extensively in the next step ---
    function createNMAminoAcid(svg, x, y, label) {
        const group = document.createElementNS(svgNS, 'g');
        group.setAttribute('transform', `translate(${x}, ${y})`);
        
        // Simplified Purine-like shape for Guanine (e.g., two fused rounded rects)
        // Main hexagon-like part
        const mainRing = document.createElementNS(svgNS, 'rect');
        mainRing.setAttribute('x', -12); 
        mainRing.setAttribute('y', -10);
        mainRing.setAttribute('width', 24);
        mainRing.setAttribute('height', 20);
        mainRing.setAttribute('rx', 3);
        mainRing.setAttribute('ry', 3);
        mainRing.setAttribute('fill', '#8BC34A'); 
        group.appendChild(mainRing);

        // Smaller pentagon-like part (fused)
        const sideRing = document.createElementNS(svgNS, 'rect');
        sideRing.setAttribute('x', 10); 
        sideRing.setAttribute('y', -7);
        sideRing.setAttribute('width', 10);
        sideRing.setAttribute('height', 14);
        sideRing.setAttribute('rx', 3);
        sideRing.setAttribute('ry', 3);
        sideRing.setAttribute('fill', '#A2D480'); 
        group.appendChild(sideRing);
        
        const textEl = document.createElementNS(svgNS, 'text');
        textEl.setAttribute('x', 0); 
        textEl.setAttribute('y', 4); 
        textEl.setAttribute('text-anchor', 'middle');
        textEl.setAttribute('font-size', '10px'); 
        textEl.setAttribute('fill', 'white');
        textEl.textContent = label;
        group.appendChild(textEl);

        group.addEventListener('mouseenter', (e) => showAnimationTooltip(e, `<b>${label || 'Guanine'} Base</b><br>A key DNA component involved in alkylation.`));
        group.addEventListener('mouseleave', hideAnimationTooltip);
        
        svg.appendChild(group);
        gsap.set(group, { opacity: 0, scale: 0.5 });
        return group;
    }
    
    function createMolecule(svg, id, x, y, atomColor, labelText, r = 20) {
        const group = document.createElementNS(svgNS, 'g');
        group.setAttribute('id', id);
        group.setAttribute('transform', `translate(${x},${y})`);
    
        const atom = document.createElementNS(svgNS, 'circle');
        atom.setAttribute('cx', 0); atom.setAttribute('cy', 0); atom.setAttribute('r', r);
        atom.setAttribute('fill', atomColor);
        group.appendChild(atom);
    
        if (labelText) {
            const labelEl = document.createElementNS(svgNS, 'text');
            labelEl.setAttribute('x', 0); labelEl.setAttribute('y', r + 15);
            labelEl.setAttribute('text-anchor', 'middle'); labelEl.setAttribute('font-size', '12px');
            labelEl.textContent = labelText;
            group.appendChild(labelEl);
            group.addEventListener('mouseenter', (e) => showAnimationTooltip(e, `<b>${labelText}</b>`));
        } else {
            group.addEventListener('mouseenter', (e) => showAnimationTooltip(e, `<b>Molecular Component</b>`));
        }
        group.addEventListener('mouseleave', hideAnimationTooltip);

        svg.appendChild(group);
        gsap.set(group, { opacity: 0, scale: 0.5 });
        return group;
    }

    function createBond(svg, id, x1, y1, x2, y2, stroke = '#333', strokeWidth = 2) {
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('id', id);
        line.setAttribute('x1', x1); line.setAttribute('y1', y1);
        line.setAttribute('x2', x1); line.setAttribute('y2', y1); 
        line.setAttribute('stroke', stroke); line.setAttribute('stroke-width', strokeWidth);
        
        line.addEventListener('mouseenter', (e) => showAnimationTooltip(e, `<b>Covalent Bond</b>`));
        line.addEventListener('mouseleave', hideAnimationTooltip);

        svg.appendChild(line);
        gsap.set(line, { opacity: 0 });
        return line;
    }
    
    function createDNAMolecule(svg, id, x, y, length = 150, color = '#4A90E2') {
        const group = document.createElementNS(svgNS, 'g');
        group.setAttribute('id', id);
        group.setAttribute('transform', `translate(${x},${y})`);
    
        const path1 = document.createElementNS(svgNS, 'path');
        path1.setAttribute('d', `M0 0 Q ${length/4} -10 ${length/2} 0 T ${length} 0`);
        path1.setAttribute('stroke', color); path1.setAttribute('stroke-width', '3'); path1.setAttribute('fill', 'none');
        path1.addEventListener('mouseenter', (e) => showAnimationTooltip(e, `<b>DNA Strand</b>`));
        path1.addEventListener('mouseleave', hideAnimationTooltip);
        group.appendChild(path1);
    
        const path2 = document.createElementNS(svgNS, 'path');
        path2.setAttribute('d', `M0 10 Q ${length/4} 20 ${length/2} 10 T ${length} 10`);
        path2.setAttribute('stroke', color); path2.setAttribute('stroke-width', '3'); path2.setAttribute('fill', 'none');
        path2.addEventListener('mouseenter', (e) => showAnimationTooltip(e, `<b>DNA Strand</b>`));
        path2.addEventListener('mouseleave', hideAnimationTooltip);
        group.appendChild(path2);
    
        for (let i = 0; i < 5; i++) {
            const rung = document.createElementNS(svgNS, 'line');
            const rungX = (length / 5) * (i + 0.5);
            const y1_approx = 5 * Math.sin( (Math.PI * rungX) / (length/2) ); 
            const y2_approx = 10 - 5 * Math.sin( (Math.PI * rungX) / (length/2) );
            rung.setAttribute('x1', rungX); rung.setAttribute('y1', y1_approx);
            rung.setAttribute('x2', rungX); rung.setAttribute('y2', y2_approx +5);
            rung.setAttribute('stroke', '#AAB8C2'); rung.setAttribute('stroke-width', '2');
            rung.addEventListener('mouseenter', (e) => showAnimationTooltip(e, `<b>Base Pair Region</b>`));
            rung.addEventListener('mouseleave', hideAnimationTooltip);
            group.appendChild(rung);
        }
        svg.appendChild(group);
        gsap.set(group, { opacity: 0, scale: 0.8 });
        return group;
    }


    const mechanisms = {
    'nitrogen-mustard': {
        steps: [
            `<b>Step 1: Meet the Nitrogen Mustard</b><br>The Nitrogen Mustard drug, characterized by its two chloroethyl 'arms', is introduced. It's poised for a chemical transformation to become highly reactive.`,
            `<b>Step 2: Aziridinium Ion Formation</b><br>A chlorine atom detaches from one arm, which then cyclizes to form a highly unstable and reactive three-membered ring called an aziridinium ion. This ion is electrophilic and seeks a nucleophile.`,
            `<b>Step 3: First Alkylation of DNA</b><br>The reactive aziridinium ion attacks the N7 atom of a guanine base in one strand of the DNA double helix, forming a covalent bond. This is the first 'hit'.`,
            `<b>Step 4: Second Alkylation & Cross-linking</b><br>The second chloroethyl arm of the Nitrogen Mustard (now attached to DNA) undergoes a similar activation, forming another reactive site that alkylates a guanine on the *opposite* DNA strand. This creates an interstrand cross-link, effectively 'stapling' the DNA strands together.`,
            `<b>Step 5: DNA Damage and Cell Fate</b><br>The interstrand cross-link prevents DNA strand separation, blocking essential cellular processes like replication and transcription. This triggers DNA damage responses, which can lead to cell cycle arrest and apoptosis (programmed cell death) of the cancer cell.`
        ],
        animations: [
            function () { // NM Step 1
                clearSVG('nm-animation');
                const svg = document.getElementById('nm-animation');
                const tl = gsap.timeline();
                const nm = createNitrogenMustardMolecule(svg, 'nm-drug', 250, 70);
                const dna = createDetailedDNAStrands(svg, 'nm-dna-s1', 250, 150, 120, 6);
                tl.to(nm.elements, { opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.7)", stagger: 0.05 })
                    .to(dna.elements, { opacity: 1, scale: 1, duration: 0.7, stagger: 0.03 }, "-=0.3");
                return tl;
            },
            function () { // NM Step 2
                clearSVG('nm-animation');
                const svg = document.getElementById('nm-animation');
                const tl = gsap.timeline();
                const initialNM = createNitrogenMustardMolecule(svg, 'nm-initial', 250, 70);
                gsap.set(initialNM.elements, { opacity: 1, scale: 1 });

                const aziridinium = createAziridiniumIon(svg, 'aziridinium', 350, 70);
                const clAtom = createMolecule(svg, 'cl-atom', initialNM.group.transform.baseVal.getItem(0).matrix.e + 50, initialNM.group.transform.baseVal.getItem(0).matrix.f - 20, '#777', 'Cl', 10);
                gsap.set(clAtom, { opacity: 1, scale: 1 });

                const firstChlorineElement = initialNM.group.querySelector(`#${'nm-initial'}-Cl-0`);
                const firstClLabel = initialNM.group.querySelector(`#${'nm-initial'}-Cl-0`).nextSibling;
                const firstBondCl = initialNM.group.querySelector(`#${'nm-initial'}-bondCl-0`);

                tl.to([firstChlorineElement, firstClLabel, clAtom], { opacity: 0, x: '-=30', duration: 0.5, ease: "power1.in" }, "+=0.2")
                    .set(firstBondCl, { opacity: 0 })
                    .to(aziridinium.elements, { opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.7)", stagger: 0.05 })
                    .fromTo(aziridinium.nitrogenAtom, { fill: '#E74C3C' }, { fill: '#FF6685', duration: 0.3, yoyo: true, repeat: 3 }, "<");
                return tl;
            },
            function () { // NM Step 3: First Alkylation
                clearSVG('nm-animation');
                const svg = document.getElementById('nm-animation');
                const tl = gsap.timeline();
                const aziridinium = createAziridiniumIon(svg, 'aziridinium', 150, 70);
                gsap.set(aziridinium.elements, { opacity: 1, scale: 1 });
                const dna = createDetailedDNAStrands(svg, 'nm-dna-s3', 300, 40, 200, 8);
                gsap.set(dna.elements, { opacity: 1, scale: 1 });

                const targetGuanine = dna.group.querySelector(`#${'nm-dna-s3'}-base1-2`);
                let targetX = 0, targetY = 0;
                if (targetGuanine && targetGuanine.dataset.n7x && targetGuanine.dataset.n7y) {
                    targetX = parseFloat(targetGuanine.dataset.n7x);
                    targetY = parseFloat(targetGuanine.dataset.n7y);
                } else {
                    targetX = 300 - amplitude / 2;
                    targetY = 40 + 200 / 3;
                }

                tl.to(aziridinium.group, { x: targetX - 10, y: targetY, duration: 0.7, ease: "power1.inOut" })
                    .call(() => {
                        const alkylBond = createGenericBond(svg, 'alkyl-bond-1', targetX - 10, targetY, targetX, targetY, '#D32F2F', 3);
                        gsap.to(alkylBond, { opacity: 1, attr: { x1: targetX - 25 }, duration: 0.4 });
                        if (targetGuanine) gsap.to(targetGuanine, { fill: '#FBC02D', duration: 0.3 });
                    });
                return tl;
            },
            function () { // NM Step 4: Second Alkylation & Cross-linking
                clearSVG('nm-animation');
                const svg = document.getElementById('nm-animation');
                const tl = gsap.timeline();
                const dna = createDetailedDNAStrands(svg, 'nm-dna-s4', 250, 40, 200, 8);
                gsap.set(dna.elements, { opacity: 1, scale: 1 });

                const attachedMustardPart = createAziridiniumIon(svg, 'attached-mustard', 0, 0);
                gsap.set(attachedMustardPart.elements, { opacity: 1, scale: 0.6 });

                const guanine1 = dna.group.querySelector(`#${'nm-dna-s4'}-base1-2`);
                const guanine2 = dna.group.querySelector(`#${'nm-dna-s4'}-base2-4`);

                let g1X = 0, g1Y = 0, g2X = 0, g2Y = 0;

                if (guanine1 && guanine1.dataset.n7x && guanine1.dataset.n7y) {
                    g1X = parseFloat(guanine1.dataset.n7x);
                    g1Y = parseFloat(guanine1.dataset.n7y);
                    gsap.set(attachedMustardPart.group, { x: g1X - 20, y: g1Y });
                    gsap.to(guanine1, { fill: '#FBC02D' });
                }

                if (guanine2 && guanine2.dataset.n7x && guanine2.dataset.n7y) {
                    g2X = parseFloat(guanine2.dataset.n7x);
                    g2Y = parseFloat(guanine2.dataset.n7y);
                    gsap.to(guanine2, { fill: '#FBC02D' });
                }

                const remainingClElement = attachedMustardPart.group.querySelector(`#${'attached-mustard'}-remainingCl`);
                const remainingClLabel = remainingClElement ? remainingClElement.nextSibling : null;
                const remainingArmBond2 = attachedMustardPart.group.querySelector(`#${'attached-mustard'}-remainingArmBond2`);

                tl.to([remainingClElement, remainingClLabel], { opacity: 0, duration: 0.3 }, "+=0.5")
                    .set(remainingArmBond2, { opacity: 0 }, "<")
                    .call(() => {
                        const crosslinkBond = createGenericBond(svg, 'nm-crosslink', g1X - 15, g1Y, g2X + 15, g2Y, '#D32F2F', 4);
                        const bondToG1 = createGenericBond(svg, 'bond-to-g1', g1X - 20, g1Y, g1X, g1Y, '#7B1FA2', 2);
                        gsap.to(bondToG1, { opacity: 1, duration: 0.2 });
                        gsap.to(crosslinkBond, { opacity: 1, duration: 0.6, ease: "elastic.out(1,0.7)" });
                    });
                return tl;
            },
            function() { // NM Step 5
                clearSVG('nm-animation');
                const svg = document.getElementById('nm-animation');
                const tl = gsap.timeline();
                
                const dna = createDetailedDNAStrands(svg, 'nm-dna-s5', 250, 40, 200);
                const guanines = dna.getGuaninePositions();
                
                const g1 = guanines[2].element;
                const g2 = guanines[5].element;
                
                const crosslink = createBond(svg, 'nm-crosslink', 
                    guanines[2].n7.x, guanines[2].n7.y,
                    guanines[5].n7.x, guanines[5].n7.y,
                    '#D32F2F', 4);
                
                tl.to(dna.elements, { opacity: 1, duration: 0.5 })
                .to([g1, g2], { fill: '#FFEB3B', duration: 0.3 })
                .to(crosslink, { 
                    attr: { 
                        x2: guanines[5].n7.x, 
                        y2: guanines[5].n7.y 
                    },
                    duration: 0.8,
                    ease: "elastic.out(1, 0.5)"
                }, "-=0.2")
                .to([dna.path1, dna.path2], {
                    attr: { 
                        d: i => i === 0 ? 
                            dna.path1.getAttribute('d').replace(/L/g, 'L') + 'Z' : 
                            dna.path2.getAttribute('d').replace(/L/g, 'L') + 'Z'
                    },
                    duration: 0.5
                });
                
                return tl;
            }
        ]
    },
    'oxazaphosphorine': {
        steps: [
            `<b>Step 1: Cyclophosphamide (Prodrug)</b><br>Cyclophosphamide is an inactive prodrug. It needs to be metabolized by the liver to become active.`,
            `<b>Step 2: Liver Activation</b><br>In the liver, Cytochrome P450 enzymes convert Cyclophosphamide to 4-hydroxycyclophosphamide, which exists in equilibrium with its tautomer, aldophosphamide.`,
            `<b>Step 3: Release of Active Bifunctional Alkylator</b><br>Aldophosphamide breaks down to yield a *bifunctional* phosphoramide mustard derivative and acrolein. This derivative has two reactive sites capable of alkylating DNA.`,
            `<b>Step 4: Second Activation and Alkylation</b><br>After the first alkylation, the second reactive group on the phosphoramide mustard derivative is activated. This activated group then alkylates a guanine on the opposite DNA strand, forming an interstrand cross-link.`,
            `<b>Step 5: Phosphoramide Mustard Alkylates DNA</b><br>The DNA cross-links formed by phosphoramide mustard disrupt DNA replication and transcription, triggering cell death pathways in cancer cells.`,
            `<b>Step 6: DNA Damage and Cell Response</b><br>The DNA cross-links formed by phosphoramide mustard disrupt DNA replication and transcription, triggering cell death pathways in cancer cells.`
        ],
        animations: [
            function () { // OX Step 1
                clearSVG('ox-animation');
                const svg = document.getElementById('ox-animation');
                const tl = gsap.timeline();
                const cp = createMolecule(svg, 'cp-drug', 150, 140, '#1E88E5', 'Cyclophosphamide', 30);
                const liver = createMolecule(svg, 'liver-ox', 350, 140, '#FB8C00', 'Liver (CYP450)', 40);
                tl.to(cp, { opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.7)" })
                    .to(liver, { opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.7)" }, "+=0.2")
                    .to(cp, { x: 300, duration: 0.8, ease: "power1.inOut" }, "+=0.3");
                return tl;
            },
            function () { // OX Step 2
                clearSVG('ox-animation');
                const svg = document.getElementById('ox-animation');
                const tl = gsap.timeline();
                const liver = createMolecule(svg, 'liver-s2', 250, 140, '#FB8C00', '', 40);
                liver.querySelector('text').textContent = '';
                const cpInside = createMolecule(svg, 'cp-inside', 250, 140, '#64B5F6', 'CP', 25);
                const ohcp = createMolecule(svg, 'ohcp-metabolite', 250, 140, '#43A047', '4-OH-CP / Aldo-CP', 28);
                tl.to(liver, { opacity: 1, scale: 1, duration: 0.3 })
                    .to(cpInside, { opacity: 1, scale: 1, duration: 0.3 }, "<")
                    .to(cpInside, { opacity: 0, scale: 0.7, duration: 0.5, ease: "power1.in" }, "+=0.5")
                    .to(ohcp, { opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.7)" }, "-=0.3");
                return tl;
            },
            function () { // OX Step 3
                clearSVG('ox-animation');
                const svg = document.getElementById('ox-animation');
                const tl = gsap.timeline();
                const ohcp = createMolecule(svg, 'ohcp-s3', 200, 140, '#43A047', 'Aldo-CP', 28);
                const pm = createMolecule(svg, 'pm-active', 330, 100, '#D81B60', 'Bifunctional Phosphoramide Mustard', 25);
                const acrolein = createMolecule(svg, 'acrolein-byproduct', 330, 180, '#757575', 'Acrolein', 15);
                tl.to(ohcp, { opacity: 1, scale: 1, duration: 0.4 })
                    .to(ohcp, { x: 170, opacity: 0, scale: 0.8, duration: 0.6, ease: "power1.in" }, "+=0.3")
                    .to([pm, acrolein], { opacity: 1, scale: 1, duration: 0.5, stagger: 0.1, ease: "back.out(1.7)" }, "-=0.3")
                    .fromTo(pm.querySelector('circle'), { fill: '#D81B60' }, { fill: '#F06292', duration: 0.3, yoyo: true, repeat: 3 }, "<");
                return tl;
            },
            function() { // OX Step 4
                clearSVG('ox-animation');
                const svg = document.getElementById('ox-animation');
                const tl = gsap.timeline();
                const pm = createMolecule(svg, 'pm-s4', 150, 120, '#D81B60', 'PM', 20);
                const dna = createDetailedDNAStrands(svg, 'dna-ox-s4', 300, 40, 200, 8);
                const guanine1 = dna.group.querySelector(`#dna-ox-s4-base1-2`);
                const guanine2 = dna.group.querySelector(`#dna-ox-s4-base2-4`);
                
                tl.to(dna.elements, { opacity: 1, scale: 1, duration: 0.5 })
                .to(pm, { opacity: 1, scale: 1, duration: 0.4 }, "<")
                .to(pm, { 
                    x: parseFloat(guanine1.dataset.n7x) - 20, 
                    y: parseFloat(guanine1.dataset.n7y), 
                    duration: 0.7 
                })
                .to(guanine1, { fill: '#FBC02D' }, "-=0.2")
                .to(pm, {
                    x: parseFloat(guanine2.dataset.n7x) + 20,
                    y: parseFloat(guanine2.dataset.n7y),
                    duration: 0.7
                })
                .to(guanine2, { fill: '#FBC02D' }, "-=0.2");
                return tl;
            },
            function() { // OX Step 5
                clearSVG('ox-animation');
                const svg = document.getElementById('ox-animation');
                const tl = gsap.timeline();
                
                const dna = createDetailedDNAStrands(svg, 'dna-ox-s5', 250, 40, 200);
                const guanines = dna.getGuaninePositions();
                
                const g1 = guanines[2].element;
                const g2 = guanines[5].element;
                
                const crosslink = createBond(svg, 'ox-crosslink', 
                    guanines[2].n7.x, guanines[2].n7.y,
                    guanines[5].n7.x, guanines[5].n7.y,
                    '#D32F2F', 4);
                
                tl.to(dna.elements, { opacity: 1, duration: 0.5 })
                .to([g1, g2], { fill: '#FFEB3B', duration: 0.3 })
                .to(crosslink, { 
                    attr: { 
                        x2: guanines[5].n7.x, 
                        y2: guanines[5].n7.y 
                    },
                    duration: 0.8,
                    ease: "elastic.out(1, 0.5)"
                }, "-=0.2")
                .to([dna.path1, dna.path2], {
                    attr: { 
                        d: i => i === 0 ? 
                            dna.path1.getAttribute('d').replace(/L/g, 'L') + 'Z' : 
                            dna.path2.getAttribute('d').replace(/L/g, 'L') + 'Z'
                    },
                    duration: 0.5
                });
                
                return tl;
            },
            function() { // OX Step 6
                clearSVG('ox-animation');
                const svg = document.getElementById('ox-animation');
                const tl = gsap.timeline();
                
                const dna = createDetailedDNAStrands(svg, 'dna-ox-s6', 250, 40, 200);
                const guanines = dna.getGuaninePositions();
                const crosslink = createBond(svg, 'ox-crosslink-s6', 
                    guanines[2].n7.x, guanines[2].n7.y,
                    guanines[5].n7.x, guanines[5].n7.y,
                    '#D32F2F', 4);
                
                tl.to(dna.elements, { opacity: 1, duration: 0.5 })
                .to(crosslink, { opacity: 1, duration: 0.5 })
                .to([dna.path1, dna.path2], {
                    attr: { 
                        d: i => i === 0 ? 
                            dna.path1.getAttribute('d').replace(/L/g, 'L') + 'Z' : 
                            dna.path2.getAttribute('d').replace(/L/g, 'L') + 'Z'
                    },
                    duration: 0.5
                })
                .to(dna.elements, { 
                    opacity: 0.5,
                    duration: 1,
                    ease: "power1.inOut"
                });
                
                return tl;
            }
        ]
    },
    'mitomycin-c': {
        steps: [
            `<b>Step 1: Mitomycin C (Prodrug)</b><br>Mitomycin C contains a quinone, an aziridine ring, and a carbamate. It requires enzymatic reduction to become an active DNA alkylator.`,
            `<b>Step 2: Enzymatic Reduction (Activation)</b><br>Cellular enzymes (e.g., DT-diaphorase) reduce the quinone moiety of Mitomycin C. This triggers a cascade of chemical changes.`,
            `<b>Step 3: Formation of Reactive Species & First DNA Alkylation</b><br>Reduction leads to the spontaneous loss of the methoxy group (if present in analogue) and opening of the aziridine ring. This activated form alkylates DNA, primarily at the N2 position of guanine in the minor groove.`,
            `<b>Step 4: Second Alkylation & Interstrand Cross-link</b><br>After the first alkylation, further activation (e.g., elimination of the carbamate group) exposes a second electrophilic site (C10). This site can then alkylate another guanine, often on the complementary DNA strand, forming an interstrand cross-link.`,
            `<b>Step 5: Potent DNA Damage</b><br>The interstrand cross-links formed by Mitomycin C are highly cytotoxic, effectively halting DNA replication and leading to cancer cell death. Its activity is often enhanced in hypoxic tumor environments.`
        ],
        animations: [
            function () { // MC Step 1
                clearSVG('mc-animation');
                const svg = document.getElementById('mc-animation');
                const tl = gsap.timeline();
                const mc = createMolecule(svg, 'mc-drug', 250, 140, '#6A1B9A', 'Mitomycin C', 30);
                tl.to(mc, { opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.7)" });
                return tl;
            },
            function () { // MC Step 2
                clearSVG('mc-animation');
                const svg = document.getElementById('mc-animation');
                const tl = gsap.timeline();
                const mc = createMolecule(svg, 'mc-s2', 250, 140, '#6A1B9A', 'Mitomycin C', 30);
                const enzyme = createMolecule(svg, 'enzyme-mc', 150, 140, '#00ACC1', 'Enzyme', 25);
                const electron = createMolecule(svg, 'electron', 180, 110, '#FDD835', 'e-', 8);
                tl.to([mc, enzyme], { opacity: 1, scale: 1, duration: 0.4, stagger: 0.1 })
                    .to(electron, { opacity: 1, scale: 1, duration: 0.2 }, "-=0.1")
                    .to(electron, { x: 240, y: 130, duration: 0.5, ease: "power1.in" })
                    .to(mc.querySelector('circle'), { fill: '#8E24AA', duration: 0.3 }, "-=0.2")
                    .to([electron, enzyme], { opacity: 0, duration: 0.3 });
                return tl;
            },
            function() { // MC Step 3
                clearSVG('mc-animation');
                const svg = document.getElementById('mc-animation');
                const tl = gsap.timeline();
                
                const activatedMC = createMolecule(svg, 'activated-mc', 150, 100, '#8E24AA', 'Activated MC', 20);
                const dna = createDetailedDNAStrands(svg, 'mc-dna-s3', 300, 50, 200);
                const guanines = dna.getGuaninePositions();
                const targetG = guanines[3];
                
                const arrow = document.createElementNS(svgNS, 'path');
                arrow.setAttribute('d', `M${activatedMC.x+30},${activatedMC.y} L${targetG.n2.x-10},${targetG.n2.y}`);
                arrow.setAttribute('marker-end', 'url(#arrowhead)');
                arrow.setAttribute('stroke', '#795548');
                arrow.setAttribute('stroke-width', 2);
                arrow.setAttribute('opacity', 0);
                svg.appendChild(arrow);
                
                tl.to(dna.elements, { opacity: 1, duration: 0.5 })
                .to(activatedMC, { 
                    x: targetG.n2.x - 25,
                    y: targetG.n2.y,
                    duration: 0.7
                })
                .to(arrow, { opacity: 1, duration: 0.3 }, "-=0.5")
                .to(targetG.element, { fill: '#FFC107', duration: 0.3 })
                .to(arrow, { opacity: 0, duration: 0.2 }, "+=0.3");
                
                return tl;
            },
            function() { // MC Step 4
                clearSVG('mc-animation');
                const svg = document.getElementById('mc-animation');
                const tl = gsap.timeline();
                
                const dna = createDetailedDNAStrands(svg, 'mc-dna-s4', 250, 40, 200);
                const guanines = dna.getGuaninePositions();
                const g1 = guanines[2];
                const g2 = guanines[5];
                
                const mcAttached = createMolecule(svg, 'mc-attached', g1.n2.x - 15, g1.n2.y, '#8E24AA', '', 10);
                const crosslink = createBond(svg, 'mc-crosslink', 
                    g1.n2.x, g1.n2.y,
                    g2.n2.x, g2.n2.y,
                    '#D32F2F', 4);
                
                tl.to(dna.elements, { opacity: 1, duration: 0.5 })
                .to(mcAttached, { opacity: 1, duration: 0.3 })
                .to([g1.element, g2.element], { fill: '#FFC107', duration: 0.3 })
                .to(crosslink, { 
                    opacity: 1,
                    duration: 0.8,
                    ease: "elastic.out(1, 0.5)"
                });
                
                return tl;
            },
            function() { // MC Step 5
                clearSVG('mc-animation');
                const svg = document.getElementById('mc-animation');
                const tl = gsap.timeline();
                
                const dna = createDetailedDNAStrands(svg, 'mc-dna-s5', 250, 40, 200);
                const guanines = dna.getGuaninePositions();
                const crosslink = createBond(svg, 'mc-crosslink-s5', 
                    guanines[2].n2.x, guanines[2].n2.y,
                    guanines[5].n2.x, guanines[5].n2.y,
                    '#D32F2F', 4);
                
                tl.to(dna.elements, { opacity: 1, duration: 0.5 })
                .to(crosslink, { opacity: 1, duration: 0.5 })
                .to([dna.path1, dna.path2], {
                    attr: { 
                        d: i => i === 0 ? 
                            dna.path1.getAttribute('d').replace(/L/g, 'L') + 'Z' : 
                            dna.path2.getAttribute('d').replace(/L/g, 'L') + 'Z'
                    },
                    duration: 0.5
                })
                .to(dna.elements, { 
                    opacity: 0.5,
                    duration: 1,
                    ease: "power1.inOut"
                });
                
                return tl;
            }
        ]
    },
    'nitrosourea': {
        steps: [
            `<b>Step 1: Introduction & Lipophilicity</b><br>Nitrosoureas (e.g., Carmustine) are highly lipophilic (fat-soluble). This allows them to easily pass through cell membranes and the blood-brain barrier, making them useful for treating brain tumors.`,
            `<b>Step 2: Decomposition to Reactive Intermediates</b><br>Nitrosoureas decompose to form a diazohydroxide and an isocyanate. The diazohydroxide can further decompose to form a *bifunctional* alkylating agent, although less directly than nitrogen mustards.`,
            `<b>Step 3: Formation of Bifunctional Alkylating Cation</b><br>The diazohydroxide decomposes to form a highly reactive *bifunctional* diazonium ion, which quickly loses nitrogen gas to form a *bifunctional* alkylating carbocation.`,
            `<b>Step 4: Second Alkylation and Cross-linking</b><br>The second reactive site on the carbocation alkylates a guanine on the opposite DNA strand, forming an interstrand cross-link.`,
            `<b>Step 5: DNA Alkylation (Guanine O6/N7)</b><br>This reactive carbocation is a powerful electrophile. It rapidly attacks nucleophilic sites on DNA, primarily the O6 or N7 positions of guanine bases, forming a covalent alkyl-DNA adduct.`,
            `<b>Step 6: Protein Carbamylation by Isocyanate</b><br>Meanwhile, the isocyanate intermediate (R-N=C=O) can react with amino groups on proteins, such as lysine or arginine residues. This process, called carbamylation, can inactivate important proteins, including DNA repair enzymes.`,
            `<b>Step 7: Cytotoxicity & Therapeutic Effect</b><br>The combination of direct DNA alkylation (causing DNA damage and replication stress) and the carbamylation of key cellular proteins (impairing DNA repair and other survival pathways) leads to significant cytotoxicity, ultimately killing the cancer cell.`
        ],
        animations: [
            function () { // NU Step 1
                clearSVG('nu-animation');
                const svg = document.getElementById('nu-animation');
                const tl = gsap.timeline();
                const nuMolecule = createMolecule(svg, 'nu-drug-s1', 250, 100, '#FF6F00', 'Nitrosourea', 30);
                const bbb = createBond(svg, 'bbb-s1', 100, 180, 400, 180, '#78909C', 5);
                gsap.set(bbb, { opacity: 0.5, strokeDasharray: "10,5" });
                tl.to(nuMolecule, { opacity: 1, scale: 1, duration: 0.5 })
                    .to(bbb, { opacity: 0.5, duration: 0.3 }, "<")
                    .to(nuMolecule, { y: 200, duration: 1, ease: "power1.inOut" });
                return tl;
            },
            function () { // NU Step 2
                clearSVG('nu-animation');
                const svg = document.getElementById('nu-animation');
                const tl = gsap.timeline();
                const nuOrig = createMolecule(svg, 'nu-orig-s2', 180, 140, '#FF6F00', 'Nitrosourea', 25);
                const diazo = createMolecule(svg, 'diazo-s2', 320, 100, '#AD1457', 'Diazohydroxide', 20);
                const isocyanate = createMolecule(svg, 'iso-s2', 320, 180, '#4527A0', 'Isocyanate', 20);
                tl.to(nuOrig, { opacity: 1, scale: 1, duration: 0.4 })
                    .to(nuOrig, { opacity: 0, scale: 0.7, x: 150, duration: 0.5, ease: "power1.in" }, "+=0.3")
                    .to([diazo, isocyanate], { opacity: 1, scale: 1, duration: 0.5, stagger: 0.1, ease: "back.out(1.7)" }, "-=0.3");
                return tl;
            },
            function () { // NU Step 3
                clearSVG('nu-animation');
                const svg = document.getElementById('nu-animation');
                const tl = gsap.timeline();
                const diazo = createMolecule(svg, 'diazo-s3', 200, 140, '#AD1457', 'Diazohydroxide', 20);
                const cation = createMolecule(svg, 'cation-s3', 330, 140, '#D84315', 'Bifunctional Alkylating Cation (+)', 22);
                tl.to(diazo, { opacity: 1, scale: 1, duration: 0.4 })
                    .to(diazo, { opacity: 0, scale: 0.7, x: 170, duration: 0.5, ease: "power1.in" }, "+=0.3")
                    .to(cation, { opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.7)" }, "-=0.3")
                    .fromTo(cation.querySelector('circle'), { fill: '#D84315' }, { fill: '#FF7043', duration: 0.3, yoyo: true, repeat: 3 });
                return tl;
            },
            function() { // NU Step 4
                clearSVG('nu-animation');
                const svg = document.getElementById('nu-animation');
                const tl = gsap.timeline();
                
                const cation = createMolecule(svg, 'nu-cation', 150, 120, '#D84315', 'Alkylating Cation', 20);
                const dna = createDetailedDNAStrands(svg, 'nu-dna-s4', 300, 50, 200);
                const guanines = dna.getGuaninePositions();
                const targetG = guanines[1];
                
                const electronCloud = document.createElementNS(svgNS, 'circle');
                electronCloud.setAttribute('cx', targetG.o6.x);
                electronCloud.setAttribute('cy', targetG.o6.y);
                electronCloud.setAttribute('r', 0);
                electronCloud.setAttribute('fill', 'none');
                electronCloud.setAttribute('stroke', '#FFEB3B');
                electronCloud.setAttribute('stroke-width', 2);
                electronCloud.setAttribute('stroke-dasharray', '3,2');
                svg.appendChild(electronCloud);
                
                tl.to(dna.elements, { opacity: 1, duration: 0.5 })
                .to(cation, {
                    x: targetG.o6.x - 15,
                    y: targetG.o6.y,
                    duration: 0.7
                })
                .to(electronCloud, {
                    attr: { r: 15 },
                    opacity: 1,
                    duration: 0.4
                }, "-=0.3")
                .to(targetG.element, { fill: '#FF9800', duration: 0.3 })
                .to(electronCloud, {
                    attr: { r: 0 },
                    opacity: 0,
                    duration: 0.3
                })
                .call(() => {
                    // Create crosslink to second guanine
                    const targetG2 = guanines[4]; // Opposite strand guanine
                    const crosslink = createBond(svg, 'nu-crosslink', 
                        targetG.o6.x, targetG.o6.y,
                        targetG2.o6.x, targetG2.o6.y,
                        '#D32F2F', 4);
                    gsap.to(crosslink, {
                        opacity: 1,
                        duration: 0.8,
                        ease: "elastic.out(1, 0.5)"
                    });
                    gsap.to(targetG2.element, { fill: '#FF9800', duration: 0.3 });
                });

                return tl;
            },
            function() { // NU Step 5
                clearSVG('nu-animation');
                const svg = document.getElementById('nu-animation');
                const tl = gsap.timeline();
                
                const dna = createDetailedDNAStrands(svg, 'nu-dna-s5', 250, 40, 200);
                const guanines = dna.getGuaninePositions();
                
                // Show alkylation at both O6 and N7 positions
                const targetG1 = guanines[1];
                const targetG2 = guanines[4];
                
                const cation1 = createMolecule(svg, 'nu-cation1', targetG1.o6.x - 15, targetG1.o6.y, '#D84315', '', 10);
                const cation2 = createMolecule(svg, 'nu-cation2', targetG2.n7.x + 15, targetG2.n7.y, '#D84315', '', 10);
                
                const bond1 = createBond(svg, 'nu-bond1', 
                    targetG1.o6.x - 10, targetG1.o6.y,
                    targetG1.o6.x, targetG1.o6.y,
                    '#7B1FA2', 2);
                
                const bond2 = createBond(svg, 'nu-bond2', 
                    targetG2.n7.x + 10, targetG2.n7.y,
                    targetG2.n7.x, targetG2.n7.y,
                    '#7B1FA2', 2);
                
                tl.to(dna.elements, { opacity: 1, duration: 0.5 })
                .to([cation1, cation2], { opacity: 1, duration: 0.3 })
                .to([targetG1.element, targetG2.element], { fill: '#FF9800', duration: 0.3 })
                .to([bond1, bond2], { opacity: 1, duration: 0.5 })
                .to([dna.path1, dna.path2], {
                    attr: { 
                        d: i => i === 0 ? 
                            dna.path1.getAttribute('d').replace(/L/g, 'L') + 'Z' : 
                            dna.path2.getAttribute('d').replace(/L/g, 'L') + 'Z'
                    },
                    duration: 0.5
                });
                
                return tl;
            },
            function() { // NU Step 6
                clearSVG('nu-animation');
                const svg = document.getElementById('nu-animation');
                const tl = gsap.timeline();
                
                const isocyanate = createMolecule(svg, 'nu-iso', 150, 120, '#4527A0', 'Isocyanate', 20);
                const protein = createMolecule(svg, 'nu-protein', 300, 120, '#00695C', 'Repair Enzyme', 30);
                
                // Create amino acid target
                const lysine = document.createElementNS(svgNS, 'g');
                lysine.setAttribute('id', 'nu-lysine');
                const lysRect = document.createElementNS(svgNS, 'rect');
                lysRect.setAttribute('x', 280);
                lysRect.setAttribute('y', 115);
                lysRect.setAttribute('width', 40);
                lysRect.setAttribute('height', 20);
                lysRect.setAttribute('rx', 3);
                lysRect.setAttribute('fill', '#00897B');
                const lysText = document.createElementNS(svgNS, 'text');
                lysText.setAttribute('x', 300);
                lysText.setAttribute('y', 130);
                lysText.setAttribute('text-anchor', 'middle');
                lysText.setAttribute('fill', 'white');
                lysText.textContent = 'Lys';
                lysine.appendChild(lysRect);
                lysine.appendChild(lysText);
                svg.appendChild(lysine);
                
                // Create carbamylated product
                const carbamyl = document.createElementNS(svgNS, 'g');
                carbamyl.setAttribute('id', 'nu-carbamyl');
                carbamyl.setAttribute('opacity', 0);
                const carbRect = lysRect.cloneNode();
                carbRect.setAttribute('fill', '#004D40');
                const carbText = document.createElementNS(svgNS, 'text');
                carbText.setAttribute('x', 300);
                carbText.setAttribute('y', 130);
                carbText.setAttribute('text-anchor', 'middle');
                carbText.setAttribute('fill', 'white');
                carbText.textContent = 'Lys-CO';
                carbamyl.appendChild(carbRect);
                carbamyl.appendChild(carbText);
                svg.appendChild(carbamyl);
                
                tl.to(dna.elements, { opacity: 0.3, duration: 0.5 })
                .to([isocyanate, protein], { opacity: 1, duration: 0.5 })
                .to(lysine, { opacity: 1, duration: 0.3 })
                .to(isocyanate, {
                    x: 280,
                    y: 120,
                    duration: 0.7,
                    ease: "power1.inOut"
                })
                .to(lysine, { opacity: 0, duration: 0.3 })
                .to(carbamyl, { opacity: 1, duration: 0.3 })
                .to(protein.querySelector('circle'), { fill: '#78909C', duration: 0.3 });
                
                return tl;
            },
            function() { // NU Step 7
                clearSVG('nu-animation');
                const svg = document.getElementById('nu-animation');
                const tl = gsap.timeline();
                
                // Show DNA damage and impaired repair
                const dna = createDetailedDNAStrands(svg, 'nu-dna-s7', 200, 40, 180);
                const guanines = dna.getGuaninePositions();
                const crosslink = createBond(svg, 'nu-crosslink-s7', 
                    guanines[1].o6.x, guanines[1].o6.y,
                    guanines[4].n7.x, guanines[4].n7.y,
                    '#D32F2F', 4);
                
                const damagedProtein = createMolecule(svg, 'nu-damaged-protein', 350, 120, '#78909C', 'Impaired Enzyme', 30);
                
                // Create cell death indicators
                const apoptosis = document.createElementNS(svgNS, 'text');
                apoptosis.setAttribute('x', 250);
                apoptosis.setAttribute('y', 250);
                apoptosis.setAttribute('text-anchor', 'middle');
                apoptosis.setAttribute('font-size', '20');
                apoptosis.setAttribute('fill', '#C62828');
                apoptosis.textContent = 'Apoptosis';
                apoptosis.setAttribute('opacity', 0);
                svg.appendChild(apoptosis);
                
                tl.to(dna.elements, { opacity: 1, duration: 0.5 })
                .to(crosslink, { opacity: 1, duration: 0.5 })
                .to([guanines[1].element, guanines[4].element], { fill: '#FF9800', duration: 0.3 })
                .to(damagedProtein, { opacity: 1, duration: 0.5 })
                .to([dna.path1, dna.path2], {
                    attr: { 
                        d: i => i === 0 ? 
                            dna.path1.getAttribute('d').replace(/L/g, 'L') + 'Z' : 
                            dna.path2.getAttribute('d').replace(/L/g, 'L') + 'Z'
                    },
                    duration: 0.5
                })
                .to(apoptosis, { opacity: 1, y: 230, duration: 0.5, ease: "back.out(1.7)" })
                .to([dna.elements, crosslink, damagedProtein], { 
                    opacity: 0.5,
                    duration: 1,
                    ease: "power1.inOut"
                });
                
                return tl;
            }
        ]
    }
};

    // --- END OF ANIMATION LOGIC (to be refined) ---

    let activeTimelines = {}; 

    function updateMechanism(agent) {
    const stepsData = mechanisms[agent];
    const stepIndex = currentStep[agent];
    const vizContainer = document.querySelector(`#${agent}-mechanism .mechanism-visualization`);
    const explanationParentBox = document.querySelector(`#${agent}-mechanism .explanation-box`);
    const explanationTitle = explanationParentBox.querySelector(`h3`);
    const explanationText = explanationParentBox.querySelector(`.explanation-text`);
    const nextButton = document.querySelector(`#${agent}-mechanism .navigation-buttons button[onclick*='next']`);
    const prevButton = document.querySelector(`#${agent}-mechanism .navigation-buttons button[onclick*='previous']`);

    if (!stepsData) { console.error("No steps data for", agent); return; }
    if (!vizContainer || !explanationParentBox || !explanationTitle || !explanationText) { 
        console.error("HTML elements missing for", agent); return; 
    }

    explanationTitle.innerHTML = `${getAgentDisplayName(agent)}: Step ${stepIndex + 1}`;
    explanationText.innerHTML = stepsData.steps[stepIndex];

    gsap.fromTo(explanationParentBox, 
        { backgroundColor: "rgba(220, 235, 255, 0.5)", y:10, opacity:0.7 }, 
        { backgroundColor: "transparent", y:0, opacity:1, duration: 0.5, ease:"power1.out" }
    );

    if (activeTimelines[agent]) {
        activeTimelines[agent].kill();
    }

    if (stepsData.animations && typeof stepsData.animations[stepIndex] === 'function') {
        activeTimelines[agent] = stepsData.animations[stepIndex](); 
        if (activeTimelines[agent] && typeof activeTimelines[agent].play === 'function') {
            activeTimelines[agent].play();
        } else {
            console.warn(`Animation function for ${agent} step ${stepIndex} did not return a valid GSAP timeline.`);
            clearSVG(`${agent.substring(0,2)}-animation`); 
        }
    } else {
        console.warn(`Animation missing for ${agent} step ${stepIndex}`);
        clearSVG(`${agent.substring(0,2)}-animation`);
    }

    // Handle Next button appearance on the last step
    if (stepIndex === stepsData.steps.length - 1) {
        nextButton.innerText = "Last Step";
        nextButton.style.backgroundColor = "#cce6ff"; // lighter blue
        nextButton.disabled = true; // optional: disable button if it's the end
    } else {
        nextButton.innerText = "Next";
        nextButton.style.backgroundColor = ""; // reset to original (assumes CSS sets default)
        nextButton.disabled = false;
    }
}


    function navigateTo(action, agent) {
    const agentMechanisms = mechanisms[agent]; 
    if (!agentMechanisms) {
        console.error("Mechanism not found for agent:", agent);
        return;
    }
    let stepIndex = currentStep[agent];

    if (action === 'next' && stepIndex < agentMechanisms.steps.length - 1) {
        currentStep[agent]++;
    } else if (action === 'previous' && stepIndex > 0) {
        currentStep[agent]--;
    } else if (action === 'restart') {
        currentStep[agent] = 0;
    }

    // Clamp index to stay within bounds
    currentStep[agent] = Math.max(0, Math.min(currentStep[agent], agentMechanisms.steps.length - 1));

    // Always update the UI
    updateMechanism(agent);
}

// Note: The detailed animation functions within mechanisms object are illustrative placeholders
// and will be significantly expanded for scientific accuracy in subsequent steps.

    // --- REVISED SVG Drawing Helper Functions (Phase 1 - Focus on NM) ---

    function createDetailedDNAStrands(svg, idPrefix, x_center, y_offset, overall_height, numSegments = 5) { // Modified parameters
        const group = document.createElementNS(svgNS, 'g');
        group.setAttribute('id', `${idPrefix}-dna-helix`);
        svg.appendChild(group);

        // Parameters based on the reference image and new vertical orientation
        const amplitude = 40;      // Horizontal spread of the helix
        const frequency = 0.025;   // Waves per unit of height (adjust for twist density)
        const segmentStep = 2;     // Step for drawing path points

        // Color Palette from reference image
        const backboneColorBlue = '#007bff'; // A clear blue
        const backboneColorRed = '#dc3545';   // A clear red
        const adenineColor = '#F08080';     // Light Coral / Pinkish-Red for A
        const thymineColor = '#F5D67D';       // Yellow/Orange for T
        const guanineColor = '#58D68D';       // Green for G (current is good)
        const cytosineColor = '#5DADE2';      // Light blue for C
        const hBondColor = '#BDC3C7';         // Light grey for H-bonds
        const labelColor = '#333';            // For 5'/3' and base letters

        const backboneWidth = 5;
        const baseRectWidthPurine = 18; // A, G
        const baseRectHeightPurine = 10;
        const baseRectWidthPyrimidine = 14; // C, T
        const baseRectHeightPyrimidine = 10;
        const baseFontSize = "8px";

        const allElements = [];
        
        // Define a sample base sequence for one strand
        const sequence = ['A', 'T', 'G', 'C', 'G', 'T', 'A', 'C', 'G', 'A']; 
        const numBasePairs = sequence.length;
        const basePairSpacing = overall_height / (numBasePairs + 1);

        // Create the two backbone strands (Vertical Orientation)
        const strandBlue = document.createElementNS(svgNS, 'path'); // Left strand (5'-3' top to bottom)
        const strandRed = document.createElementNS(svgNS, 'path');   // Right strand (3'-5' top to bottom)
        
        let dBlue = '';
        let dRed = '';
        const startY = y_offset;
        const endY = y_offset + overall_height;

        for (let currentY = startY; currentY <= endY; currentY += segmentStep) {
            const xBlue = x_center - amplitude * Math.cos(frequency * (currentY - startY)); // Cosine for side-to-side start
            const xRed  = x_center - amplitude * Math.cos(frequency * (currentY - startY) + Math.PI); // 180deg phase offset
            
            if (currentY === startY) {
                dBlue += `M${xBlue},${currentY}`;
                dRed += `M${xRed},${currentY}`;
            } else {
                dBlue += ` L${xBlue},${currentY}`;
                dRed += ` L${xRed},${currentY}`;
            }
        }
        
        strandBlue.setAttribute('d', dBlue);
        strandBlue.setAttribute('stroke', backboneColorBlue);
        strandBlue.setAttribute('stroke-width', backboneWidth);
        strandBlue.setAttribute('fill', 'none');
        strandBlue.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>5\'-3\' DNA Backbone</b><br>(Blue Strand)'));
        strandBlue.addEventListener('mouseleave', hideAnimationTooltip);
        group.appendChild(strandBlue);
        allElements.push(strandBlue);
        
        strandRed.setAttribute('d', dRed);
        strandRed.setAttribute('stroke', backboneColorRed);
        strandRed.setAttribute('stroke-width', backboneWidth);
        strandRed.setAttribute('fill', 'none');
        strandRed.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>3\'-5\' DNA Backbone</b><br>(Red Strand)'));
        strandRed.addEventListener('mouseleave', hideAnimationTooltip);
        group.appendChild(strandRed);
        allElements.push(strandRed);

        // Add 5' and 3' labels
        const fivePrimeBlue = createLabel(svg, `${idPrefix}-5pb`, x_center - amplitude - 15, startY, "5'");
        const threePrimeBlue = createLabel(svg, `${idPrefix}-3pb`, x_center - amplitude * Math.cos(frequency * overall_height) - 15, endY + 15, "3'");
        const threePrimeRed = createLabel(svg, `${idPrefix}-3pr`, x_center - amplitude * Math.cos(Math.PI) + 15, startY, "3'");
        const fivePrimeRed = createLabel(svg, `${idPrefix}-5pr`, x_center - amplitude * Math.cos(frequency * overall_height + Math.PI) + 15, endY + 15, "5'");
        gsap.set([fivePrimeBlue, threePrimeBlue, threePrimeRed, fivePrimeRed], {opacity: 1, fill: labelColor, fontSize: "12px", fontWeight:"bold"});
        allElements.push(fivePrimeBlue, threePrimeBlue, threePrimeRed, fivePrimeRed);
        
        // Create base pairs
        for (let i = 0; i < numBasePairs; i++) {
            const currentY = y_offset + (i + 1) * basePairSpacing;
            const xBlue = x_center - amplitude * Math.cos(frequency * (currentY - startY));
            const xRed  = x_center - amplitude * Math.cos(frequency * (currentY - startY) + Math.PI);

            const baseTypeStrand1 = sequence[i];
            let baseTypeStrand2, color1, color2, width1, height1, width2, height2, label1, label2;
            let tooltip1, tooltip2;

            switch (baseTypeStrand1) {
                case 'A':
                    baseTypeStrand2 = 'T'; color1 = adenineColor; color2 = thymineColor;
                    width1 = baseRectWidthPurine; height1 = baseRectHeightPurine;
                    width2 = baseRectWidthPyrimidine; height2 = baseRectHeightPyrimidine;
                    label1 = 'A'; label2 = 'T';
                    tooltip1 = '<b>Adenine (A)</b>'; tooltip2 = '<b>Thymine (T)</b>';
                    break;
                case 'T':
                    baseTypeStrand2 = 'A'; color1 = thymineColor; color2 = adenineColor;
                    width1 = baseRectWidthPyrimidine; height1 = baseRectHeightPyrimidine;
                    width2 = baseRectWidthPurine; height2 = baseRectHeightPurine;
                    label1 = 'T'; label2 = 'A';
                    tooltip1 = '<b>Thymine (T)</b>'; tooltip2 = '<b>Adenine (A)</b>';
                    break;
                case 'G':
                    baseTypeStrand2 = 'C'; color1 = guanineColor; color2 = cytosineColor;
                    width1 = baseRectWidthPurine; height1 = baseRectHeightPurine;
                    width2 = baseRectWidthPyrimidine; height2 = baseRectHeightPyrimidine;
                    label1 = 'G'; label2 = 'C';
                    tooltip1 = '<b>Guanine (G)</b><br>Target for alkylation.'; tooltip2 = '<b>Cytosine (C)</b>';
                    break;
                case 'C':
                    baseTypeStrand2 = 'G'; color1 = cytosineColor; color2 = guanineColor;
                    width1 = baseRectWidthPyrimidine; height1 = baseRectHeightPyrimidine;
                    width2 = baseRectWidthPurine; height2 = baseRectHeightPurine;
                    label1 = 'C'; label2 = 'G';
                    tooltip1 = '<b>Cytosine (C)</b>'; tooltip2 = '<b>Guanine (G)</b><br>Target for alkylation.';
                    break;
            }

            // Base on Blue Strand (Strand 1)
            const base1 = document.createElementNS(svgNS, 'rect');
            base1.setAttribute('id', `${idPrefix}-base1-${i}`);
            base1.setAttribute('x', xBlue - (baseTypeStrand1 === 'A' || baseTypeStrand1 === 'G' ? width1/2 : width1/2)); // Centered on backbone
            base1.setAttribute('y', currentY - height1/2);
            base1.setAttribute('width', width1);
            base1.setAttribute('height', height1);
            base1.setAttribute('fill', color1);
            base1.setAttribute('rx', 2); base1.setAttribute('ry', 2);
            base1.addEventListener('mouseenter', (e) => showAnimationTooltip(e, tooltip1));
            base1.addEventListener('mouseleave', hideAnimationTooltip);
            group.appendChild(base1);
            allElements.push(base1);

            const baseLabel1 = createLabel(svg, `${idPrefix}-b1label-${i}`, xBlue, currentY + baseFontSize/2.5 , label1);
            gsap.set(baseLabel1, {opacity:1, fill:"white", fontSize: baseFontSize, pointerEvents: 'none'});
            allElements.push(baseLabel1);


            // Base on Red Strand (Strand 2)
            const base2 = document.createElementNS(svgNS, 'rect');
            base2.setAttribute('id', `${idPrefix}-base2-${i}`);
            base2.setAttribute('x', xRed - (baseTypeStrand2 === 'A' || baseTypeStrand2 === 'G' ? width2/2 : width2/2)); // Centered on backbone
            base2.setAttribute('y', currentY - height2/2);
            base2.setAttribute('width', width2);
            base2.setAttribute('height', height2);
            base2.setAttribute('fill', color2);
            base2.setAttribute('rx', 2); base2.setAttribute('ry', 2);
            base2.addEventListener('mouseenter', (e) => showAnimationTooltip(e, tooltip2));
            base2.addEventListener('mouseleave', hideAnimationTooltip);
            group.appendChild(base2);
            allElements.push(base2);
            
            const baseLabel2 = createLabel(svg, `${idPrefix}-b2label-${i}`, xRed, currentY + baseFontSize/2.5, label2);
            gsap.set(baseLabel2, {opacity:1, fill:"white", fontSize: baseFontSize, pointerEvents: 'none'});
            allElements.push(baseLabel2);

            // Hydrogen Bonds (simplified as single line)
            const hBond = document.createElementNS(svgNS, 'line');
            hBond.setAttribute('x1', xBlue);
            hBond.setAttribute('y1', currentY);
            hBond.setAttribute('x2', xRed);
            hBond.setAttribute('y2', currentY);
            hBond.setAttribute('stroke', hBondColor);
            hBond.setAttribute('stroke-width', '2');
            hBond.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Hydrogen Bonds</b>'));
            hBond.addEventListener('mouseleave', hideAnimationTooltip);
            group.appendChild(hBond);
            allElements.push(hBond);
            
            // Store guanine N7 positions if it's a guanine for alkylation targeting
            if (baseTypeStrand1 === 'G') {
                base1.dataset.n7x = xBlue + (width1 / 2) * 0.6; // Approx N7 on outer edge
                base1.dataset.n7y = currentY;
            }
            if (baseTypeStrand2 === 'G') {
                base2.dataset.n7x = xRed - (width2 / 2) * 0.6; // Approx N7 on outer edge
                base2.dataset.n7y = currentY;
            }
        }
        
        gsap.set(allElements, { opacity: 0, scale: 0.9, transformOrigin: "center center" });
        return { group, elements: allElements, path1: strandBlue, path2: strandRed }; 
    }

    function createNitrogenMustardMolecule(svg, id, x, y) {
        const group = document.createElementNS(svgNS, 'g');
        group.setAttribute('id', id);
        group.setAttribute('transform', `translate(${x},${y})`);
        svg.appendChild(group);

        const atomRadiusN = 8;
        const atomRadiusC = 6; // Slightly smaller for C
        const atomRadiusCl = 7;
        const labelFontSize = "8px";
        const labelColor = "#FFFFFF"; // White labels

        const centralN = document.createElementNS(svgNS, 'circle');
        centralN.setAttribute('id', `${id}-N`);
        centralN.setAttribute('cx', 0); centralN.setAttribute('cy', 0); centralN.setAttribute('r', atomRadiusN);
        centralN.setAttribute('fill', '#8E44AD'); // Purple for Nitrogen
        centralN.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Nitrogen Atom (N)</b>'));
        centralN.addEventListener('mouseleave', hideAnimationTooltip);
        group.appendChild(centralN);
        
        const nLabel = document.createElementNS(svgNS, 'text');
        nLabel.setAttribute('x', 0); nLabel.setAttribute('y', 0);
        nLabel.setAttribute('text-anchor', 'middle'); nLabel.setAttribute('dy', '.3em'); // Vertical alignment
        nLabel.setAttribute('font-size', labelFontSize); nLabel.setAttribute('fill', labelColor);
        nLabel.textContent = 'N';
        group.appendChild(nLabel);

        const elements = [centralN, nLabel];
        const bondLength = 30;
        const armAngle = 45; // degrees

        for (let i = 0; i < 2; i++) { // Two arms
            const angle = i === 0 ? -armAngle : armAngle;
            const ethylX1 = bondLength * Math.cos(angle * Math.PI / 180);
            const ethylY1 = bondLength * Math.sin(angle * Math.PI / 180);
            const ethylX2 = (bondLength + 20) * Math.cos(angle * Math.PI / 180);
            const ethylY2 = (bondLength + 20) * Math.sin(angle * Math.PI / 180);
            const clX = (bondLength + 45) * Math.cos(angle * Math.PI / 180); // Increased length for Cl label
            const clY = (bondLength + 45) * Math.sin(angle * Math.PI / 180);

            const bond1 = document.createElementNS(svgNS, 'line');
            bond1.setAttribute('x1', 0); bond1.setAttribute('y1', 0);
            bond1.setAttribute('x2', ethylX1); bond1.setAttribute('y2', ethylY1);
            bond1.setAttribute('stroke', '#333'); bond1.setAttribute('stroke-width', 2);
            group.appendChild(bond1); elements.push(bond1);

            const c1 = document.createElementNS(svgNS, 'circle'); // CH2
            c1.setAttribute('cx', ethylX1); c1.setAttribute('cy', ethylY1); c1.setAttribute('r', atomRadiusC); c1.setAttribute('fill', '#5D6D7E');
            group.appendChild(c1); elements.push(c1);
            const c1Label = document.createElementNS(svgNS, 'text');
            c1Label.setAttribute('x', ethylX1); c1Label.setAttribute('y', ethylY1);
            c1Label.setAttribute('text-anchor', 'middle'); c1Label.setAttribute('dy', '.3em');
            c1Label.setAttribute('font-size', labelFontSize); c1Label.setAttribute('fill', labelColor);
            c1Label.textContent = 'C';
            group.appendChild(c1Label); elements.push(c1Label);
            c1.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Carbon Atom (C)</b><br>Part of the chloroethyl arm.'));
            c1.addEventListener('mouseleave', hideAnimationTooltip);
            c1Label.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Carbon Atom (C)</b><br>Part of the chloroethyl arm.'));
            c1Label.addEventListener('mouseleave', hideAnimationTooltip);

            const bond2 = document.createElementNS(svgNS, 'line');
            bond2.setAttribute('x1', ethylX1); bond2.setAttribute('y1', ethylY1);
            bond2.setAttribute('x2', ethylX2); bond2.setAttribute('y2', ethylY2);
            bond2.setAttribute('stroke', '#333'); bond2.setAttribute('stroke-width', 2);
            group.appendChild(bond2); elements.push(bond2);
            
            const c2 = document.createElementNS(svgNS, 'circle'); // CH2
            c2.setAttribute('id', `${id}-CH2-${i}`);
            c2.setAttribute('cx', ethylX2); c2.setAttribute('cy', ethylY2); c2.setAttribute('r', atomRadiusC); c2.setAttribute('fill', '#5D6D7E');
            group.appendChild(c2); elements.push(c2);
            const c2Label = document.createElementNS(svgNS, 'text');
            c2Label.setAttribute('x', ethylX2); c2Label.setAttribute('y', ethylY2);
            c2Label.setAttribute('text-anchor', 'middle'); c2Label.setAttribute('dy', '.3em');
            c2Label.setAttribute('font-size', labelFontSize); c2Label.setAttribute('fill', labelColor);
            c2Label.textContent = 'C';
            group.appendChild(c2Label); elements.push(c2Label);
            c2.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Carbon Atom (C)</b><br>Part of the chloroethyl arm.'));
            c2.addEventListener('mouseleave', hideAnimationTooltip);
            c2Label.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Carbon Atom (C)</b><br>Part of the chloroethyl arm.'));
            c2Label.addEventListener('mouseleave', hideAnimationTooltip);

            const bondCl = document.createElementNS(svgNS, 'line');
            bondCl.setAttribute('id', `${id}-bondCl-${i}`);
            bondCl.setAttribute('x1', ethylX2); bondCl.setAttribute('y1', ethylY2);
            bondCl.setAttribute('x2', clX); bondCl.setAttribute('y2', clY);
            bondCl.setAttribute('stroke', '#333'); bondCl.setAttribute('stroke-width', 2);
            group.appendChild(bondCl); elements.push(bondCl);

            const chlorine = document.createElementNS(svgNS, 'circle');
            chlorine.setAttribute('id', `${id}-Cl-${i}`);
            chlorine.setAttribute('cx', clX); chlorine.setAttribute('cy', clY); chlorine.setAttribute('r', atomRadiusCl);
            chlorine.setAttribute('fill', '#1ABC9C'); // Teal for Chlorine
            chlorine.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Chlorine Atom (Cl)</b><br>Leaving group.'));
            chlorine.addEventListener('mouseleave', hideAnimationTooltip);
            group.appendChild(chlorine); elements.push(chlorine);
            const clLabel = document.createElementNS(svgNS, 'text');
            clLabel.setAttribute('x', clX); clLabel.setAttribute('y', clY);
            clLabel.setAttribute('text-anchor', 'middle'); clLabel.setAttribute('dy', '.3em');
            clLabel.setAttribute('font-size', labelFontSize); clLabel.setAttribute('fill', labelColor);
            clLabel.textContent = 'Cl';
            group.appendChild(clLabel); elements.push(clLabel);
            clLabel.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Chlorine Atom (Cl)</b><br>On the remaining arm.'));
            clLabel.addEventListener('mouseleave', hideAnimationTooltip);
        }
        gsap.set(elements, { opacity: 0, scale: 0.8, transformOrigin: "center center" });
        return { group, elements };
    }

    function createAziridiniumIon(svg, id, x, y) {
        const group = document.createElementNS(svgNS, 'g');
        group.setAttribute('id', id);
        group.setAttribute('transform', `translate(${x},${y})`);
        svg.appendChild(group);
        const elements = [];

        const atomRadiusN = 8;
        const atomRadiusC = 6;
        const atomRadiusCl = 7;
        const labelFontSize = "8px";
        const labelColor = "#FFFFFF";
        const nPlusLabelColor = "#FFFFFF"; // N+ label

        // Simplified aziridinium ring + remaining arm
        const N = document.createElementNS(svgNS, 'circle'); N.setAttribute('cx', 0); N.setAttribute('cy', 0); N.setAttribute('r', atomRadiusN); N.setAttribute('fill', '#E74C3C'); group.appendChild(N); elements.push(N); // Red for reactive N
        N.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Reactive Nitrogen (N+)</b><br>Forms the aziridinium ion.'));
        N.addEventListener('mouseleave', hideAnimationTooltip);
        const nLabel = document.createElementNS(svgNS, 'text');
        nLabel.setAttribute('x', 0); nLabel.setAttribute('y', 0);
        nLabel.setAttribute('text-anchor', 'middle'); nLabel.setAttribute('dy', '.3em');
        nLabel.setAttribute('font-size', labelFontSize); nLabel.setAttribute('fill', nPlusLabelColor);
        nLabel.textContent = 'N+'; // Reactive Nitrogen label
        group.appendChild(nLabel); elements.push(nLabel);
        
        const C1 = document.createElementNS(svgNS, 'circle'); C1.setAttribute('cx', -15); C1.setAttribute('cy', 15); C1.setAttribute('r', atomRadiusC); C1.setAttribute('fill', '#5D6D7E'); group.appendChild(C1); elements.push(C1);
        const c1Label = document.createElementNS(svgNS, 'text');
        c1Label.setAttribute('x', -15); c1Label.setAttribute('y', 15);
        c1Label.setAttribute('text-anchor', 'middle'); c1Label.setAttribute('dy', '.3em');
        c1Label.setAttribute('font-size', labelFontSize); c1Label.setAttribute('fill', labelColor);
        c1Label.textContent = 'C';
        group.appendChild(c1Label); elements.push(c1Label);
        C1.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Carbon Atom (C)</b><br>Part of the aziridinium ring.'));
        C1.addEventListener('mouseleave', hideAnimationTooltip);
        c1Label.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Carbon Atom (C)</b><br>Part of the aziridinium ring.'));
        c1Label.addEventListener('mouseleave', hideAnimationTooltip);

        const C2 = document.createElementNS(svgNS, 'circle'); C2.setAttribute('cx', 15); C2.setAttribute('cy', 15); C2.setAttribute('r', atomRadiusC); C2.setAttribute('fill', '#5D6D7E'); group.appendChild(C2); elements.push(C2);
        const c2Label = document.createElementNS(svgNS, 'text');
        c2Label.setAttribute('x', 15); c2Label.setAttribute('y', 15);
        c2Label.setAttribute('text-anchor', 'middle'); c2Label.setAttribute('dy', '.3em');
        c2Label.setAttribute('font-size', labelFontSize); c2Label.setAttribute('fill', labelColor);
        c2Label.textContent = 'C';
        group.appendChild(c2Label); elements.push(c2Label);
        C2.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Carbon Atom (C)</b><br>Part of the aziridinium ring.'));
        C2.addEventListener('mouseleave', hideAnimationTooltip);
        c2Label.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Carbon Atom (C)</b><br>Part of the aziridinium ring.'));
        c2Label.addEventListener('mouseleave', hideAnimationTooltip);
        
        const bondN_C1 = document.createElementNS(svgNS, 'line'); bondN_C1.setAttribute('x1',0); bondN_C1.setAttribute('y1',0); bondN_C1.setAttribute('x2',-15); bondN_C1.setAttribute('y2',15); bondN_C1.setAttribute('stroke','#333'); bondN_C1.setAttribute('stroke-width',2); group.appendChild(bondN_C1); elements.push(bondN_C1);
        const bondN_C2 = document.createElementNS(svgNS, 'line'); bondN_C2.setAttribute('x1',0); bondN_C2.setAttribute('y1',0); bondN_C2.setAttribute('x2',15); bondN_C2.setAttribute('y2',15); bondN_C2.setAttribute('stroke','#333'); bondN_C2.setAttribute('stroke-width',2); group.appendChild(bondN_C2); elements.push(bondN_C2);
        const bondC1_C2 = document.createElementNS(svgNS, 'line'); bondC1_C2.setAttribute('x1',-15); bondC1_C2.setAttribute('y1',15); bondC1_C2.setAttribute('x2',15); bondC1_C2.setAttribute('y2',15); bondC1_C2.setAttribute('stroke','#333'); bondC1_C2.setAttribute('stroke-width',2); group.appendChild(bondC1_C2); elements.push(bondC1_C2);

        // Represent remaining arm (simplified)
        const armAttachPointX = 0; const armAttachPointY = 0; // From N
        const armEthylCX = 0; const armEthylCY = -25; // Position for Carbon on remaining arm
        const armClX = 0; const armClY = -45; // Position for Cl on remaining arm

        const remainingArmBond1 = document.createElementNS(svgNS, 'line'); 
        remainingArmBond1.setAttribute('id',`${id}-remainingArmBond1`); 
        remainingArmBond1.setAttribute('x1',armAttachPointX); remainingArmBond1.setAttribute('y1',armAttachPointY); 
        remainingArmBond1.setAttribute('x2',armEthylCX); remainingArmBond1.setAttribute('y2',armEthylCY); 
        remainingArmBond1.setAttribute('stroke','#333'); remainingArmBond1.setAttribute('stroke-width',2); 
        group.appendChild(remainingArmBond1); elements.push(remainingArmBond1);

        const remainingC = document.createElementNS(svgNS, 'circle'); 
        remainingC.setAttribute('id',`${id}-remainingC`); 
        remainingC.setAttribute('cx',armEthylCX); remainingC.setAttribute('cy',armEthylCY); 
        remainingC.setAttribute('r',atomRadiusC); remainingC.setAttribute('fill','#5D6D7E'); 
        group.appendChild(remainingC); elements.push(remainingC);
        const remainingCLabel = document.createElementNS(svgNS, 'text');
        remainingCLabel.setAttribute('x', armEthylCX); remainingCLabel.setAttribute('y', armEthylCY);
        remainingCLabel.setAttribute('text-anchor', 'middle'); remainingCLabel.setAttribute('dy', '.3em');
        remainingCLabel.setAttribute('font-size', labelFontSize); remainingCLabel.setAttribute('fill', labelColor);
        remainingCLabel.textContent = 'C';
        group.appendChild(remainingCLabel); elements.push(remainingCLabel);
        remainingC.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Carbon Atom (C)</b><br>Part of the remaining arm.'));
        remainingC.addEventListener('mouseleave', hideAnimationTooltip);
        remainingCLabel.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Carbon Atom (C)</b><br>Part of the remaining arm.'));
        remainingCLabel.addEventListener('mouseleave', hideAnimationTooltip);

        const remainingArmBond2 = document.createElementNS(svgNS, 'line'); 
        remainingArmBond2.setAttribute('id',`${id}-remainingArmBond2`); 
        remainingArmBond2.setAttribute('x1',armEthylCX); remainingArmBond2.setAttribute('y1',armEthylCY); 
        remainingArmBond2.setAttribute('x2',armClX); remainingArmBond2.setAttribute('y2',armClY); 
        remainingArmBond2.setAttribute('stroke','#333'); remainingArmBond2.setAttribute('stroke-width',2); 
        group.appendChild(remainingArmBond2); elements.push(remainingArmBond2);
        
        const remainingCl = document.createElementNS(svgNS, 'circle'); 
        remainingCl.setAttribute('id',`${id}-remainingCl`); 
        remainingCl.setAttribute('cx',armClX); remainingCl.setAttribute('cy',armClY); 
        remainingCl.setAttribute('r',atomRadiusCl); remainingCl.setAttribute('fill','#1ABC9C'); 
        group.appendChild(remainingCl); elements.push(remainingCl);
        const remainingClLabel = document.createElementNS(svgNS, 'text');
        remainingClLabel.setAttribute('x', armClX); remainingClLabel.setAttribute('y', armClY);
        remainingClLabel.setAttribute('text-anchor', 'middle'); remainingClLabel.setAttribute('dy', '.3em');
        remainingClLabel.setAttribute('font-size', labelFontSize); remainingClLabel.setAttribute('fill', labelColor);
        remainingClLabel.textContent = 'Cl';
        group.appendChild(remainingClLabel); elements.push(remainingClLabel);
        remainingCl.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Chlorine Atom (Cl)</b><br>On the remaining arm.'));
        remainingCl.addEventListener('mouseleave', hideAnimationTooltip);
        remainingClLabel.addEventListener('mouseenter', (e) => showAnimationTooltip(e, '<b>Chlorine Atom (Cl)</b><br>On the remaining arm.'));
        remainingClLabel.addEventListener('mouseleave', hideAnimationTooltip);


        gsap.set(elements, { opacity: 0, scale: 0.8, transformOrigin: "center center" });
        return { group, elements, nitrogenAtom: N };
    }
    
    function createLabel(svg, id, x, y, textContent) {
        const label = document.createElementNS(svgNS, 'text');
        label.setAttribute('id', id);
        label.setAttribute('x', x);
        label.setAttribute('y', y);
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('font-size', '14px');
        label.setAttribute('fill', '#333');
        label.textContent = textContent;
        svg.appendChild(label);
        gsap.set(label, { opacity: 0 });
        return label;
    }

    // Generic bond for cross-links etc.
    function createGenericBond(svg, id, x1, y1, x2, y2, stroke = '#C0392B', strokeWidth = 3) {
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('id', id);
        line.setAttribute('x1', x1); line.setAttribute('y1', y1);
        line.setAttribute('x2', x1); // Start as point, animate to x2
        line.setAttribute('y2', y1); // Start as point, animate to y2
        line.setAttribute('stroke', stroke);
        line.setAttribute('stroke-width', strokeWidth);
        svg.appendChild(line);
        gsap.set(line, { opacity: 0 });
        return line;
    }


    

</script>

<style>

    /* Add to your existing CSS */
.key-points, .activation-pathway {
    background: rgba(245, 245, 245, 0.8);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border-left: 5px solid #1a2980;
}

.comparison-table {
    width: 100%;
    margin: 20px 0;
    border-collapse: collapse;
}

.comparison-table th, .comparison-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.comparison-table th {
    background-color: #1a2980;
    color: white;
}

.comparison-table tr:nth-child(even) {
    background-color: #f2f2f2;
}

.molecular-detail {
    background: rgba(255, 255, 255, 0.9);
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

    .drug-card {
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .drug-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }
    
    .drug-card-link {
        text-decoration: none;
        color: inherit;
    }
    /* Add highlight style for target sections */
    :target {
        animation: highlight 2s ease;
    }
    
    @keyframes highlight {
        from { background-color: rgba(100, 200, 255, 0.3); }
        to { background-color: transparent; }
    }

    .animation-tooltip {
        position: absolute;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 13px;
        pointer-events: none; /* Very important to prevent tooltip from interfering with mouse events on SVG */
        opacity: 0;
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        z-index: 10000; /* Ensure it's on top */
        white-space: nowrap;
        transform: translate(-50%, -110%); /* Position above cursor, centered */
    }
    

    /* Add highlight style for target sections */
    :target {
        animation: highlight 2s ease;
    }

    @keyframes highlight {
        from { background-color: rgba(100, 200, 255, 0.3); }
        to { background-color: transparent; }
    }
</style>

</body>
</html>
